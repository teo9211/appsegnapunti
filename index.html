<!DOCTYPE html>
<html lang="it">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Archery Tracker - Il Tuo Diario di Tiro</title>
    
    <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/teo9211/appsegnapunti/main/IMG_3452.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/teo9211/appsegnapunti/main/IMG_3452.jpg?raw=true">
    <link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/teo9211/appsegnapunti/main/IMG_3452.jpg?raw=true">
    <meta name="msapplication-TileImage" content="https://raw.githubusercontent.com/teo9211/appsegnapunti/main/IMG_3452.jpg?raw=true">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #fdb927;
        }
        .app-container {
            min-height: 100vh;
        }
        .btn-primary {
            background-color: #fdb927;
            color: #1a1a1a;
            font-weight: 800;
            transition: transform 0.1s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-primary:hover {
            background-color: #e5a400;
            transform: scale(1.02);
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .input-style {
            background-color: #2c2c2c;
            border: 1px solid #4a4a4a;
            color: #fdb927;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
        }
        .score-grid th, .score-grid td {
            border: 1px solid #4a4a4a;
            padding: 0.5rem 0.2rem;
            text-align: center;
            font-size: 0.9rem;
            line-height: 1.2;
            touch-action: manipulation;
        }
        .score-grid th {
            background-color: #2c2c2c;
            color: #fdb927;
            font-weight: 600;
        }
        .score-cell {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .grid-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 640px) {
            .score-grid th, .score-grid td {
                padding: 0.6rem 0.2rem;
                font-size: 0.85rem;
            }
            body {
                font-size: 14px;
            }
            .btn-primary {
                min-height: 48px;
            }
        }
        
        @media screen and (max-width: 767px) {
            input, select, textarea {
                font-size: 16px;
            }
        }
        
        .keypad-button {
            min-height: 48px;
            font-size: 1.25rem;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .stats-card {
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            border: 2px solid #fdb927;
            border-radius: 12px;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .progress-bar {
            background-color: #2c2c2c;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #fdb927 0%, #e5a400 100%);
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background-dark': '#1a1a1a',
                        'primary-orange': '#fdb927',
                        'secondary-dark': '#2c2c2c',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-dark text-primary-orange">

    <div id="app" class="app-container p-4 max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <div class="flex justify-center mb-4">
                <img src="https://raw.githubusercontent.com/teo9211/appsegnapunti/main/IMG_3452.jpg" alt="Logo Archery" class="h-24 w-auto rounded-lg shadow-lg">
            </div>
            <h1 class="text-4xl font-extrabold tracking-tight text-white">Archery Tracker</h1>
            <p class="text-sm mt-1 text-primary-orange">Il tuo diario di allenamenti e gare</p>
            <div id="user-info" class="mt-0 text-sm text-white"></div>
        </header>

        <div id="content-view"></div>

        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div id="modal-content" class="bg-secondary-dark p-6 rounded-xl shadow-2xl max-w-sm w-full border-2 border-primary-orange max-h-[90vh] overflow-y-auto">
                <h3 id="modal-title" class="text-2xl font-bold mb-4 text-white">Titolo</h3>
                <div id="modal-body" class="mb-6 text-sm"></div>
                <div id="modal-actions" class="flex justify-end space-x-3"></div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const MASTER_PASSWORD = "mecca";
    const appId = 'appsegnapunti'; 
    
    const firebaseConfig = {
        apiKey: "AIzaSyCeCB6X7RzwCPoUE7xZcH-vFQpfqYAIAsk",
        authDomain: "appsegnapunti.firebaseapp.com",
        projectId: "appsegnapunti",
        storageBucket: "appsegnapunti.firebasestorage.app",
        messagingSenderId: "44781964428",
        appId: "1:44781964428:web:ff8fb6d9595e2224637fa9"
    };
    
    let app, db, auth;
    let userId = null;
    let chartInstance = null;

    setLogLevel('debug');

    document.getElementById('content-view').innerHTML = `
        <div class="text-center p-8">
            <p class="text-2xl text-white">Caricamento in corso...</p>
            <p class="text-sm text-primary-orange mt-2">Inizializzazione Firebase</p>
        </div>
    `;

    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    userId = user.uid;
                    console.log('Autenticazione Firebase riuscita. User ID:', userId);
                    window.initializeApp(db, userId, auth);
                } else {
                    console.log('Accesso anonimo a Firebase per visualizzare lista utenti.');
                    const anonUser = await signInAnonymously(auth);
                    userId = anonUser.user.uid;
                    window.initializeApp(db, userId, auth);
                }
            } catch (error) {
                console.error("Errore autenticazione:", error);
                document.getElementById('content-view').innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-2xl text-red-500">Errore di Autenticazione</p>
                        <p class="text-sm text-white mt-2">${error.message}</p>
                        <button class="btn-primary mt-4 px-6 py-2 rounded-lg" onclick="location.reload()">Riprova</button>
                    </div>
                `;
            }
        });

    } catch (e) {
        console.error("Errore inizializzazione Firebase:", e);
        document.getElementById('content-view').innerHTML = `
            <div class="text-center p-8">
                <p class="text-2xl text-red-500">Errore di Inizializzazione</p>
                <p class="text-sm text-white mt-2">${e.message}</p>
                <button class="btn-primary mt-4 px-6 py-2 rounded-lg" onclick="location.reload()">Riprova</button>
            </div>
        `;
    }

    // QUESTA √à LA FINE DELLA PARTE1
// PARTE2
window.initializeApp = (db, firebaseUserId, authInstance) => {
        const appState = {
            view: 'login',
            loggedInArcher: null,
            sessionType: null,
            currentSession: null,
            currentTurn: 1,
            sessionData: [],
            detailedSession: null,
            scoringGrid: null,
            firebaseUserId: firebaseUserId,
            auth: authInstance,
            allArchers: [],
            userGoals: [],
            volleyNotes: {},
            statistics: {},
        };

        const scoringState = {
            rows: 0,
            cols: 3,
            format: null,
            activeCell: { row: 1, col: 1 },
            startTime: null,
            personalAverage: 0,
        };

        const TIPO_TARGA_OPTIONS = ['40', '60', '80', '120', 'Tripla', 'Tripla Vegas', 'Field', '3D', 'Altro'];
        const DISTANZA_OPTIONS = ['18mt', '25mt', '40mt', '50mt', '60mt', '70mt'];
        const TIPO_LUOGO_OPTIONS = ['Indoor', 'Outdoor'];
        const FORMATO_GARA_OPTIONS = ['30 frecce (3x10)', '36 frecce (6x6)', '72 frecce (6x12)'];
        const KEYPAD_VALUES = ['X', '10', '9', '8', '7', '6', '5', '4', '3', '2', '1', 'M', 'CANC'];

        window.getArchersCollectionRef = () => {
            return collection(db, `artifacts/${appId}/archers`);
        };

        window.getSessionsCollectionRef = () => {
            if (!appState.loggedInArcher) return null;
            return collection(db, `artifacts/${appId}/archers/${appState.loggedInArcher.id}/sessions`);
        };

        window.getGoalsCollectionRef = () => {
            if (!appState.loggedInArcher) return null;
            return collection(db, `artifacts/${appId}/archers/${appState.loggedInArcher.id}/goals`);
        };
        
        function pad(num) {
            return num < 10 ? '0' + num : num;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/D';
            const parts = dateString.split('-');
            if (parts.length !== 3) return dateString;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function getFormattedTime(date) {
            return `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
        }

        function durationToString(minutes) {
            if (!minutes) return 'N/A';
            const h = Math.floor(minutes / 60);
            const m = Math.round(minutes % 60);
            return `${h} ore e ${m} min`;
        }

        function getScoreValue(value) {
            if (value === 'X') return 10;
            if (value === 'M' || value === 'm') return 0;
            return parseInt(value) || 0;
        }
        
        function sortVolleyScores(scores) {
            const scoreOrder = { 'X': 0, '10': 1, '9': 2, '8': 3, '7': 4, '6': 5, '5': 6, '4': 7, '3': 8, '2': 9, '1': 10, 'M': 11, 'm': 11, '': 12 };
            return scores.sort((a, b) => {
                const aOrder = scoreOrder[a] !== undefined ? scoreOrder[a] : 12;
                const bOrder = scoreOrder[b] !== undefined ? scoreOrder[b] : 12;
                return aOrder - bOrder;
            });
        }

        function calculateVolley(volleyScores, cumulativeTotal) {
            let parziale = 0;
            let xCount = 0;
            let tenCount = 0;
            let nineCount = 0;

            for (const score of volleyScores) {
                const val = getScoreValue(score);
                parziale += val;

                if (score === 'X') {
                    xCount++;
                } else if (val === 10 && score === '10') {
                    tenCount++;
                } else if (val === 9) {
                    nineCount++;
                }
            }

            return {
                scores: volleyScores,
                parziale: parziale,
                totale: cumulativeTotal + parziale,
                X10: `${xCount}-${tenCount}`,
                nine: nineCount,
                x: xCount,
                ten: tenCount,
            };
        }

        function calculateTurnScores(grid) {
            let cumulativeTotal = 0;
            let totalX = 0;
            let totalTen = 0;
            let totalNine = 0;
            let totalShots = 0;
            const results = [];

            for (let i = 0; i < grid.length; i++) {
                const volleyScores = grid[i].filter(s => s !== '' && s !== undefined);
                
                if (volleyScores.length > 0) {
                    const volleyResult = calculateVolley(volleyScores, cumulativeTotal);
                    
                    cumulativeTotal = volleyResult.totale;
                    totalX += volleyResult.x;
                    totalTen += volleyResult.ten;
                    totalNine += volleyResult.nine;
                    totalShots += volleyScores.length;

                    results.push({
                        volley: i + 1,
                        ...volleyResult
                    });
                }
            }

            const totalScore = cumulativeTotal;
            const totalFrecce = scoringState.rows * scoringState.cols;
            const maxScore = totalFrecce * 10;
            const average = totalShots > 0 ? (totalScore / totalShots) : 0;
            
            return {
                score: totalScore,
                X: totalX,
                Ten: totalTen,
                Nine: totalNine,
                average: average,
                frecceTirate: totalShots,
                maxScore: maxScore,
                volleys: results,
            };
        }

        function showModal(title, body, actions = []) {
            document.getElementById('modal-title').textContent = title;
            
            if (typeof body === 'string') {
                document.getElementById('modal-body').innerHTML = body;
            } else {
                document.getElementById('modal-body').innerHTML = '';
                document.getElementById('modal-body').appendChild(body);
            }
            
            const actionsContainer = document.getElementById('modal-actions');
            actionsContainer.innerHTML = '';
            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = 'btn-primary px-4 py-2 rounded-lg font-semibold';
                btn.textContent = action.text;
                btn.onclick = () => {
                    action.handler();
                    closeModal();
                };
                actionsContainer.appendChild(btn);
            });

            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function updateUserInfo() {
            const userInfoDiv = document.getElementById('user-info');
            if (appState.loggedInArcher) {
                userInfoDiv.innerHTML = `
                    Loggato come: <strong>${appState.loggedInArcher.nome}</strong> | 
                    <button class="text-primary-orange underline" onclick="window.logout()">Logout</button>
                `;
            } else {
                userInfoDiv.innerHTML = '';
            }
        }

        window.logout = async () => {
            try {
                appState.loggedInArcher = null;
                appState.currentSession = null;
                appState.sessionData = [];
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                }
                window.setView('login');
            } catch (error) {
                console.error("Errore durante il logout:", error);
                showModal("Errore", "Impossibile effettuare il logout.", [
                    { text: "Ok", handler: () => {} }
                ]);
            }
        };

        window.setView = (viewName, data = {}) => {
            appState.view = viewName;
            document.getElementById('content-view').innerHTML = '';
            closeModal();

            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
            }

            updateUserInfo();

            switch (viewName) {
                case 'login':
                    renderLogin();
                    break;
                case 'register':
                    renderRegister();
                    break;
                case 'mainMenu':
                    renderMainMenu();
                    break;
                case 'registrationForm':
                    renderRegistrationForm(data.type);
                    break;
                case 'quickScore':
                    renderQuickScore();
                    break;
                case 'trainingNotes':
                    renderTrainingNotes();
                    break;
                case 'scoring':
                    initializeScoringGrid();
                    renderScoringView();
                    break;
                case 'dataSummary':
                    fetchSessions();
                    renderDataSummary();
                    break;
                case 'detailedSummary':
                    const sessionToView = appState.sessionData.find(s => 
                        String(s.id) === String(data.sessionId)
                    );
                    
                    if (!sessionToView) {
                        console.error("Sessione non trovata:", data.sessionId);
                        window.setView('dataSummary');
                        return; 
                    }
                    
                    appState.detailedSession = sessionToView;
                    renderDetailedSummary();
                    break;
                case 'editNotes':
                    renderEditNotes(data.sessionId);
                    break;
                case 'goals':
                    renderGoals();
                    break;
                case 'compareSessionsView':
                    renderCompareSessionsView();
                    break;
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'multipleCharts':
                    renderMultipleCharts();
                    break;
                case 'exportData':
                    renderExportData();
                    break;
                case 'calendar':
                    renderCalendar();
                    break;
                case 'charts':
                    renderChartsView();
                    break;
            }
        };
        // FINE PARTE2
// PARTE3 - Login, Registrazione, Menu
        async function loadAllArchers() {
            try {
                const archersRef = window.getArchersCollectionRef();
                const querySnapshot = await getDocs(archersRef);
                
                appState.allArchers = [];
                querySnapshot.forEach((doc) => {
                    appState.allArchers.push({ id: doc.id, ...doc.data() });
                });
                
                appState.allArchers.sort((a, b) => a.nome.localeCompare(b.nome));
                
                console.log('Caricati', appState.allArchers.length, 'arcieri');
            } catch (error) {
                console.error("Errore caricamento arcieri:", error);
            }
        }

        function renderLogin() {
            loadAllArchers().then(() => {
                const html = `
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold mb-6 text-white text-center">Seleziona il tuo Profilo</h2>
                        ${appState.allArchers.length > 0 ? `
                            <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6">
                                <h3 class="text-xl font-bold mb-4 text-primary-orange">Arcieri Registrati</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-96 overflow-y-auto">
                                    ${appState.allArchers.map(archer => `
                                        <button class="bg-gray-800 hover:bg-gray-700 p-4 rounded-lg text-left border-2 border-transparent hover:border-primary-orange transition-all"
                                                onclick="window.selectArcher('${archer.id}')">
                                            <div class="font-bold text-white text-lg">${archer.nome}</div>
                                            <div class="text-sm text-primary-orange mt-1">Clicca per accedere</div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6 text-center">
                                <p class="text-white">Nessun arciere registrato ancora.</p>
                            </div>
                        `}
                        <div class="bg-secondary-dark p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-primary-orange">Nuovo Arciere?</h3>
                            <button class="btn-primary w-full p-3 rounded-lg text-lg" onclick="window.setView('register')">
                                Registra Nuovo Arciere
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('content-view').innerHTML = html;
            });
        }

        window.selectArcher = (archerId) => {
            const archer = appState.allArchers.find(a => a.id === archerId);
            if (!archer) return;
            
            const html = `
                <div class="max-w-md mx-auto">
                    <h2 class="text-3xl font-bold mb-2 text-white text-center">${archer.nome}</h2>
                    <p class="text-center text-primary-orange mb-6">Inserisci la password per accedere</p>
                    <form id="passwordForm" class="space-y-4 bg-secondary-dark p-6 rounded-xl shadow-lg">
                        <div>
                            <label class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="archer-password" class="input-style" required placeholder="Inserisci la password" autofocus>
                        </div>
                        <button type="submit" class="btn-primary w-full p-3 rounded-lg text-lg">Accedi</button>
                    </form>
                    <button class="bg-gray-400 hover:bg-gray-500 text-black w-full p-3 rounded-lg text-lg font-bold mt-3" onclick="window.setView('login')">
                        ‚Üê Torna alla lista
                    </button>
                </div>
            `;
            document.getElementById('content-view').innerHTML = html;
            
            document.getElementById('passwordForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const password = document.getElementById('archer-password').value;
                
                if (password === MASTER_PASSWORD || password === archer.password) {
                    appState.loggedInArcher = archer;
                    appState.firebaseUserId = archer.id;
                    console.log('Login effettuato:', archer.nome);
                    window.setView('mainMenu');
                } else {
                    showModal("Errore", "Password errata.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                }
            });
        };

        function renderRegister() {
            const html = `
                <div class="max-w-md mx-auto">
                    <button class="text-primary-orange underline mb-4" onclick="window.setView('login')">
                        ‚Üê Torna alla lista
                    </button>
                    
                    <h2 class="text-3xl font-bold mb-6 text-white text-center">Registrazione Nuovo Arciere</h2>
                    <form id="registerForm" class="space-y-4 bg-secondary-dark p-6 rounded-xl shadow-lg">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nome Arciere</label>
                            <input type="text" id="register-nome" class="input-style" required placeholder="Scegli un nome">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="register-password" class="input-style" required placeholder="Scegli una password (min 4 caratteri)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Conferma Password</label>
                            <input type="password" id="register-password-confirm" class="input-style" required placeholder="Conferma la password">
                        </div>
                        <button type="submit" class="btn-primary w-full p-3 rounded-lg text-lg">Registrati</button>
                    </form>
                </div>
            `;
            document.getElementById('content-view').innerHTML = html;

            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const nome = document.getElementById('register-nome').value.trim();
                const password = document.getElementById('register-password').value;
                const passwordConfirm = document.getElementById('register-password-confirm').value;

                if (password !== passwordConfirm) {
                    showModal("Errore", "Le password non coincidono.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                    return;
                }

                if (nome.length < 3) {
                    showModal("Errore", "Il nome deve essere di almeno 3 caratteri.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                    return;
                }

                if (password.length < 4) {
                    showModal("Errore", "La password deve essere di almeno 4 caratteri.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                    return;
                }

                try {
                    const archersRef = window.getArchersCollectionRef();
                    const q = query(archersRef, where('nome', '==', nome));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        showModal("Errore", "Questo nome arciere √® gi√† in uso. Scegline un altro.", [
                            { text: "Ok", handler: () => {} }
                        ]);
                        return;
                    }

                    const newArcher = {
                        nome: nome,
                        password: password,
                        createdAt: serverTimestamp()
                    };

                    const docRef = await addDoc(archersRef, newArcher);
                    console.log("Arciere registrato con ID:", docRef.id);

                    showModal("Successo", `Benvenuto ${nome}! Registrazione completata.`, [
                        { text: "Accedi", handler: () => {
                            appState.loggedInArcher = { id: docRef.id, ...newArcher };
                            appState.firebaseUserId = docRef.id;
                            window.setView('mainMenu');
                        }}
                    ]);

                } catch (error) {
                    console.error("Errore durante la registrazione:", error);
                    showModal("Errore", "Si √® verificato un errore. Riprova.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                }
            });
        }

        function renderMainMenu() {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            const html = `
                <div class="text-center space-y-3">
                    <h2 class="text-2xl font-bold mb-4 text-white">Benvenuto, ${appState.loggedInArcher.nome}!</h2>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-primary-orange mb-3">üìã Registra Sessione</h3>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg" onclick="window.setView('registrationForm', { type: 'Allenamento' })">
                            üéØ Allenamento üèãÔ∏è
                        </button>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg mt-2" onclick="window.setView('registrationForm', { type: 'Gara' })">
                            üèÜ Gara ü•á
                        </button>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-primary-orange mb-3">üìä Analisi e Statistiche</h3>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg" onclick="window.setView('dashboard')">
                            üéØ Dashboard Statistiche
                        </button>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg mt-2" onclick="window.setView('dataSummary')">
                            üßæ Riepilogo Dati
                        </button>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg mt-2" onclick="window.setView('charts')">
                            üìà Grafico Andamento
                        </button>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg mt-2" onclick="window.setView('multipleCharts')">
                            üìä Grafici Multipli
                        </button>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg mt-2" onclick="window.setView('compareSessionsView')">
                            ‚öñÔ∏è Confronta Sessioni
                        </button>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-primary-orange mb-3">üéØ Obiettivi e Pianificazione</h3>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg" onclick="window.setView('goals')">
                            üèÖ I Miei Obiettivi
                        </button>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg mt-2" onclick="window.setView('calendar')">
                            üìÖ Calendario Sessioni
                        </button>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-primary-orange mb-3">üíæ Gestione Dati</h3>
                        <button class="btn-primary w-full p-4 rounded-xl shadow-lg" onclick="window.setView('exportData')">
                            üì• Esporta & Backup
                        </button>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t-2 border-gray-700">
                        <button class="bg-red-600 hover:bg-red-700 text-white w-full p-4 rounded-xl shadow-lg font-bold" onclick="window.showDeleteProfileSection()">
                            üóëÔ∏è Elimina Profilo
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('content-view').innerHTML = html;
        }

        window.showDeleteProfileSection = () => {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            const html = `
                <div class="max-w-md mx-auto">
                    <button class="text-primary-orange underline mb-4" onclick="window.setView('mainMenu')">
                        ‚Üê Torna al Menu
                    </button>
                    
                    <h2 class="text-3xl font-bold mb-4 text-white text-center">Elimina Profilo</h2>
                    <p class="text-center mb-4 text-white">Stai per eliminare il profilo di <strong class="text-primary-orange">${appState.loggedInArcher.nome}</strong></p>
                    <p class="text-center mb-6 text-red-500 font-bold">‚ö†Ô∏è ATTENZIONE: Questa azione eliminer√† definitivamente il tuo profilo e TUTTE le sessioni associate!</p>
                    
                    <form id="deleteProfileForm" class="space-y-4 bg-secondary-dark p-6 rounded-xl shadow-lg border-2 border-red-600">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-white">Conferma con la tua Password</label>
                            <input type="password" id="delete-profile-password" class="input-style" required placeholder="Inserisci password per confermare" autofocus>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg font-bold" onclick="window.setView('mainMenu')">
                                Annulla
                            </button>
                            <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg font-bold">
                                Elimina Definitivamente
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('content-view').innerHTML = html;
            
            document.getElementById('deleteProfileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const password = document.getElementById('delete-profile-password').value;
                
                if (!password) {
                    showModal("Errore", "Inserisci la password per confermare.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                    return;
                }
                
                if (password !== MASTER_PASSWORD && password !== appState.loggedInArcher.password) {
                    showModal("Errore", "Password errata. Impossibile eliminare il profilo.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                    return;
                }
                
                try {
                    const archerId = appState.loggedInArcher.id;
                    const archerName = appState.loggedInArcher.nome;
                    
                    const sessionsRef = collection(db, `artifacts/${appId}/archers/${archerId}/sessions`);
                    const sessionsSnapshot = await getDocs(sessionsRef);
                    
                    const deletePromises = [];
                    sessionsSnapshot.forEach((sessionDoc) => {
                        deletePromises.push(deleteDoc(sessionDoc.ref));
                    });
                    
                    await Promise.all(deletePromises);
                    
                    const goalsRef = collection(db, `artifacts/${appId}/archers/${archerId}/goals`);
                    const goalsSnapshot = await getDocs(goalsRef);
                    
                    const deleteGoalsPromises = [];
                    goalsSnapshot.forEach((goalDoc) => {
                        deleteGoalsPromises.push(deleteDoc(goalDoc.ref));
                    });
                    
                    await Promise.all(deleteGoalsPromises);
                    
                    const archerDocRef = doc(db, `artifacts/${appId}/archers/${archerId}`);
                    await deleteDoc(archerDocRef);
                    
                    console.log("Profilo eliminato:", archerName);
                    
                    appState.loggedInArcher = null;
                    appState.currentSession = null;
                    appState.sessionData = [];
                    
                    showModal("Successo", `Il profilo di ${archerName} √® stato eliminato con successo.`, [
                        { text: "Ok", handler: () => window.setView('login') }
                    ]);
                    
                } catch (error) {
                    console.error("Errore eliminazione profilo:", error);
                    showModal("Errore", `Si √® verificato un errore: ${error.message}`, [
                        { text: "Ok", handler: () => {} }
                    ]);
                }
            });
        };
        // FINE PARTE3
// PARTE4A - Form Registrazione Sessione, Allenamenti Tecnici, Quick Score, Segnapunti
        function renderRegistrationForm(type) {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            appState.sessionType = type;
            scoringState.startTime = getFormattedTime(new Date());
            const session = appState.currentSession || {};
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const defaultTime = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            const isTrainingWithoutScore = session.trainingWithoutScore || false;

            const formFields = [
                { id: 'data', label: 'Data', type: 'date', required: true, value: session.data || today },
                { id: 'ora', label: 'Ora', type: 'time', required: true, value: session.startTime || defaultTime },
                { id: 'luogo', label: 'Luogo', type: 'text', required: true, value: session.luogo || '', placeholder: 'Nome Luogo' },
                { id: 'tipoLuogo', label: 'Tipo Luogo', type: 'select', options: TIPO_LUOGO_OPTIONS, required: true, value: session.tipoLuogo || '' },
            ];

            const conditionalFields = [
                { id: 'distanza', label: 'Distanza', type: 'select', options: DISTANZA_OPTIONS, required: true, value: session.distanza || '' },
                { id: 'tipoTarga', label: 'Tipo Targa', type: 'select', options: TIPO_TARGA_OPTIONS, required: true, value: session.tipoTarga || '' },
                { id: 'formatoGara', label: 'Formato Freccia', type: 'select', options: FORMATO_GARA_OPTIONS, required: true, value: session.formatoGara || '' },
            ];

            const html = `
                <h2 class="text-3xl font-bold mb-6 text-white">${type}</h2>
                <form id="registrationForm" class="space-y-4">
                    ${type === 'Allenamento' ? `
                        <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border-2 border-primary-orange">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="trainingWithoutScore" name="trainingWithoutScore" 
                                       class="w-5 h-5 mr-3" 
                                       onchange="window.toggleTrainingMode(this.checked)"
                                       ${isTrainingWithoutScore ? 'checked' : ''}>
                                <span class="text-white font-bold">Allenamento Tecnico (senza punteggio)</span>
                            </label>
                            <p class="text-sm text-primary-orange mt-2 ml-8">Seleziona questa opzione per esercizi di tecnica, perfezionamento, ecc.</p>
                        </div>
                    ` : ''}

                    ${formFields.map(field => `
                        <div>
                            <label for="${field.id}" class="block text-sm font-medium mb-1">${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}</label>
                            ${field.type === 'select' ? `
                                <select id="${field.id}" name="${field.id}" class="input-style" ${field.required ? 'required' : ''}>
                                    <option value="" disabled ${!field.value ? 'selected' : ''}>Seleziona ${field.label}</option>
                                    ${field.options.map(opt => `<option value="${opt}" ${field.value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            ` : field.type === 'textarea' ? `
                                <textarea id="${field.id}" name="${field.id}" class="input-style h-20" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}>${field.value}</textarea>
                            ` : `
                                <input type="${field.type}" id="${field.id}" name="${field.id}" class="input-style" value="${field.value}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''}>
                            `}
                        </div>
                    `).join('')}

                    <div id="conditionalFields" style="display: ${isTrainingWithoutScore ? 'none' : 'block'}">
                        ${conditionalFields.map(field => `
                            <div>
                                <label for="${field.id}" class="block text-sm font-medium mb-1">${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}</label>
                                <select id="${field.id}" name="${field.id}" class="input-style" ${field.required && !isTrainingWithoutScore ? 'required' : ''}>
                                    <option value="" disabled ${!field.value ? 'selected' : ''}>Seleziona ${field.label}</option>
                                    ${field.options.map(opt => `<option value="${opt}" ${field.value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                        `).join('')}
                    </div>

                    <div>
                        <label for="note" class="block text-sm font-medium mb-1">Note</label>
                        <textarea id="note" name="note" class="input-style h-20" placeholder="Dettagli aggiuntivi...">${session.note || ''}</textarea>
                    </div>

                    <div class="mt-8 flex flex-col space-y-3">
                        <button type="submit" class="btn-primary w-full p-3 rounded-lg text-lg" id="submitBtn">
                            ${isTrainingWithoutScore ? 'Continua' : 'Inizia Primo Turno'}
                        </button>
                        ${!isTrainingWithoutScore ? `
                            <button type="button" class="btn-primary w-full p-3 rounded-lg bg-purple-600 hover:bg-purple-700 text-white border-0" onclick="window.startQuickScore()">
                                ‚ö° Quick Score (Inserimento Rapido)
                            </button>
                        ` : ''}
                        <button type="button" class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">Torna Indietro</button>
                    </div>
                </form>
            `;

            document.getElementById('content-view').innerHTML = html;

            document.getElementById('registrationForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const session = Object.fromEntries(formData.entries());
                session.type = appState.sessionType;
                session.arciere = appState.loggedInArcher.nome;
                session.archerId = appState.loggedInArcher.id;
                session.startTime = scoringState.startTime;
                session.id = Date.now();
                session.trainingWithoutScore = document.getElementById('trainingWithoutScore')?.checked || false;

                appState.currentSession = session;

                if (session.trainingWithoutScore) {
                    window.setView('trainingNotes');
                } else {
                    window.setView('scoring');
                }
            });
        }

        window.toggleTrainingMode = (isChecked) => {
            const conditionalFields = document.getElementById('conditionalFields');
            const submitBtn = document.getElementById('submitBtn');
            const requiredInputs = conditionalFields.querySelectorAll('select[required]');

            if (isChecked) {
                conditionalFields.style.display = 'none';
                submitBtn.textContent = 'Continua';
                requiredInputs.forEach(input => input.removeAttribute('required'));
            } else {
                conditionalFields.style.display = 'block';
                submitBtn.textContent = 'Inizia Primo Turno';
                requiredInputs.forEach(input => input.setAttribute('required', 'required'));
            }
        };

        window.startQuickScore = () => {
            const formData = new FormData(document.getElementById('registrationForm'));
            const session = Object.fromEntries(formData.entries());
            
            // Validazione campi obbligatori
            if (!session.data || !session.ora || !session.luogo || !session.tipoLuogo || 
                !session.distanza || !session.tipoTarga || !session.formatoGara) {
                showModal("Errore", "Compila tutti i campi obbligatori prima di procedere.", [
                    { text: "Ok", handler: () => {} }
                ]);
                return;
            }

            session.type = appState.sessionType;
            session.arciere = appState.loggedInArcher.nome;
            session.archerId = appState.loggedInArcher.id;
            session.startTime = scoringState.startTime;
            session.id = Date.now();
            session.quickScore = true;

            appState.currentSession = session;
            window.setView('quickScore');
        };

        function renderQuickScore() {
            if (!appState.loggedInArcher || !appState.currentSession) {
                window.setView('login');
                return;
            }

            const session = appState.currentSession;
            const savedTurn1 = session.quickScoreTurn1 || '';
            const savedTurn2 = session.quickScoreTurn2 || '';

            const html = `
                <h2 class="text-3xl font-bold mb-4 text-white">‚ö° Quick Score</h2>
                <p class="text-sm mb-6 text-primary-orange">${session.distanza} | ${session.tipoTarga} | ${session.formatoGara}</p>
                
                <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6">
                    <h3 class="text-xl font-bold mb-4 text-white">Inserimento Rapido Punteggi</h3>
                    <p class="text-sm text-primary-orange mb-4">Inserisci solo i punteggi totali per ogni turno</p>
                    
                    <form id="quickScoreForm" class="space-y-4">
                        <div>
                            <label for="turn1-score" class="block text-lg font-medium mb-2 text-white">
                                Punteggio Turno 1 <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="turn1-score" name="turn1Score" 
                                   class="input-style text-2xl text-center font-bold" 
                                   min="0" max="360" required
                                   value="${savedTurn1}"
                                   placeholder="Es: 285">
                        </div>

                        ${session.formatoGara !== '72 frecce (6x12)' ? `
                            <div>
                                <label for="turn2-score" class="block text-lg font-medium mb-2 text-white">
                                    Punteggio Turno 2 (opzionale)
                                </label>
                                <input type="number" id="turn2-score" name="turn2Score" 
                                       class="input-style text-2xl text-center font-bold" 
                                       min="0" max="360"
                                       value="${savedTurn2}"
                                       placeholder="Es: 290">
                            </div>
                        ` : ''}

                        <div class="mt-8 flex flex-col space-y-3">
                            <button type="submit" class="btn-primary w-full p-3 rounded-lg text-lg">
                                üíæ Salva Quick Score
                            </button>
                            <button type="button" class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" 
                                    onclick="window.setView('registrationForm', { type: '${session.type}' })">
                                Torna Indietro
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-yellow-900 bg-opacity-30 p-4 rounded-xl border border-yellow-500">
                    <p class="text-sm text-yellow-200">
                        ‚ÑπÔ∏è <strong>Nota:</strong> Con Quick Score non avrai la griglia dettagliata dei punteggi, 
                        ma solo i totali per turno. Ideale per inserimenti veloci dopo la gara.
                    </p>
                </div>
            `;

            document.getElementById('content-view').innerHTML = html;

            document.getElementById('quickScoreForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const turn1Score = parseInt(document.getElementById('turn1-score').value);
                const turn2ScoreInput = document.getElementById('turn2-score');
                const turn2Score = turn2ScoreInput ? parseInt(turn2ScoreInput.value) || 0 : 0;

                if (!turn1Score || turn1Score < 0) {
                    showModal("Errore", "Inserisci un punteggio valido per il Turno 1.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                    return;
                }

                const endTime = new Date();
                appState.currentSession.endTime = getFormattedTime(endTime);
                appState.currentSession.duration = calculateDuration(appState.currentSession.startTime, appState.currentSession.endTime);

                // Salva i dati quick score
                appState.currentSession.quickScoreTurn1 = turn1Score;
                appState.currentSession.quickScoreTurn2 = turn2Score;
                appState.currentSession.totalScore = turn1Score + turn2Score;
                appState.currentSession.turn1Score = turn1Score;
                appState.currentSession.turn2Score = turn2Score;

                // Valori default per statistiche
                appState.currentSession.totalX = 0;
                appState.currentSession.totalTen = 0;
                appState.currentSession.totalNine = 0;
                appState.currentSession.totalAverage = 0;

                const sessionIdBeforeSave = appState.currentSession.id;
                await saveQuickScoreToFirestore();

                const modalBody = `
                    <p class="text-white mb-3">Quick Score salvato con successo!</p>
                    <p class="text-sm text-primary-orange">Totale: ${turn1Score + turn2Score} punti</p>
                    <p class="text-sm text-primary-orange">Durata: ${durationToString(appState.currentSession.duration)}</p>
                `;

                showModal("Quick Score Salvato!", modalBody, [
                    { text: "Vedi Riepilogo", handler: () => {
                        setTimeout(() => {
                            fetchSessions();
                            setTimeout(() => {
                                window.setView('detailedSummary', { sessionId: sessionIdBeforeSave });
                            }, 500);
                        }, 300);
                    }}
                ]);
            });
        }

        async function saveQuickScoreToFirestore() {
            try {
                const session = appState.currentSession;

                const finalSessionData = {
                    type: session.type,
                    arciere: session.arciere,
                    archerId: session.archerId,
                    data: session.data,
                    startTime: session.startTime,
                    endTime: session.endTime,
                    duration: session.duration,
                    luogo: session.luogo,
                    tipoLuogo: session.tipoLuogo,
                    distanza: session.distanza,
                    tipoTarga: session.tipoTarga,
                    formatoGara: session.formatoGara,
                    note: session.note || '',
                    quickScore: true,
                    quickScoreTurn1: session.quickScoreTurn1,
                    quickScoreTurn2: session.quickScoreTurn2,
                    totalScore: session.totalScore,
                    turn1Score: session.turn1Score,
                    turn2Score: session.turn2Score,
                    totalX: 0,
                    totalTen: 0,
                    totalNine: 0,
                    totalAverage: 0,
                    timestamp: serverTimestamp(),
                };

                const docRef = await addDoc(window.getSessionsCollectionRef(), finalSessionData);
                console.log("Quick Score salvato con ID:", docRef.id);
                appState.currentSession = null;
            } catch (e) {
                console.error("Errore salvataggio Quick Score:", e);
                showModal("Errore", "Impossibile salvare il Quick Score.", [{ text: "Ok", handler: () => {} }]);
            }
        }

        function renderTrainingNotes() {
            if (!appState.loggedInArcher || !appState.currentSession) {
                window.setView('login');
                return;
            }

            const session = appState.currentSession;
            const savedNotes = session.trainingContent || '';

            const html = `
                <h2 class="text-3xl font-bold mb-4 text-white">Allenamento Tecnico</h2>
                <p class="text-sm mb-6 text-primary-orange">Descrivi le attivit√† svolte durante l'allenamento</p>
                
                <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6">
                    <h3 class="text-xl font-bold mb-4 text-white">Informazioni Sessione</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><strong>Data:</strong> ${formatDate(session.data)}</div>
                        <div><strong>Ora:</strong> ${session.ora}</div>
                        <div><strong>Luogo:</strong> ${session.luogo}</div>
                        <div><strong>Tipo:</strong> ${session.tipoLuogo}</div>
                    </div>
                </div>
                
                <form id="trainingNotesForm" class="space-y-4">
                    <div>
                        <label for="trainingContent" class="block text-lg font-medium mb-2 text-white">
                            Contenuto Allenamento <span class="text-red-500">*</span>
                        </label>
                        <textarea id="trainingContent" name="trainingContent" 
                                  class="input-style h-64" 
                                  required
                                  placeholder="Descrivi gli esercizi svolti, tecniche praticate, obiettivi raggiunti, problemi riscontrati, ecc...">${savedNotes}</textarea>
                        <p class="text-xs text-primary-orange mt-1">Sii dettagliato: questo ti aiuter√† a monitorare i progressi nel tempo</p>
                    </div>
                    
                    <div class="mt-8 flex flex-col space-y-3">
                        <button type="submit" class="btn-primary w-full p-3 rounded-lg text-lg">
                            Salva Allenamento
                        </button>
                        <button type="button" class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" 
                                onclick="window.setView('registrationForm', { type: 'Allenamento' })">
                            Torna Indietro
                        </button>
                    </div>
                </form>
            `;

            document.getElementById('content-view').innerHTML = html;

            document.getElementById('trainingNotesForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const trainingContent = document.getElementById('trainingContent').value.trim();

                if (!trainingContent) {
                    showModal("Errore", "Inserisci una descrizione dell'allenamento.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                    return;
                }

                const endTime = new Date();
                appState.currentSession.endTime = getFormattedTime(endTime);
                appState.currentSession.duration = calculateDuration(appState.currentSession.startTime, appState.currentSession.endTime);
                appState.currentSession.trainingContent = trainingContent;

                const sessionIdBeforeSave = appState.currentSession.id;
                await saveTrainingWithoutScoreToFirestore();

                const modalBody = `
                    <p class="text-white mb-3">Allenamento tecnico salvato con successo!</p>
                    <p class="text-sm text-primary-orange">Durata: ${durationToString(appState.currentSession.duration)}</p>
                `;

                showModal("Allenamento Salvato!", modalBody, [
                    { text: "Vedi Riepilogo", handler: () => {
                        setTimeout(() => {
                            fetchSessions();
                            setTimeout(() => {
                                window.setView('detailedSummary', { sessionId: sessionIdBeforeSave });
                            }, 500);
                        }, 300);
                    }}
                ]);
            });
        }

        async function saveTrainingWithoutScoreToFirestore() {
            try {
                const session = appState.currentSession;

                const finalSessionData = {
                    type: session.type,
                    arciere: session.arciere,
                    archerId: session.archerId,
                    data: session.data,
                    startTime: session.startTime,
                    endTime: session.endTime,
                    duration: session.duration,
                    luogo: session.luogo,
                    tipoLuogo: session.tipoLuogo,
                    note: session.note || '',
                    trainingWithoutScore: true,
                    trainingContent: session.trainingContent,
                    timestamp: serverTimestamp(),
                    totalScore: 0,
                    totalX: 0,
                    totalTen: 0,
                    totalNine: 0,
                    totalAverage: 0,
                    distanza: session.distanza || 'N/A',
                    tipoTarga: session.tipoTarga || 'N/A',
                    formatoGara: session.formatoGara || 'N/A',
                };

                const docRef = await addDoc(window.getSessionsCollectionRef(), finalSessionData);
                console.log("Allenamento tecnico salvato con ID:", docRef.id);
                appState.currentSession = null;
            } catch (e) {
                console.error("Errore salvataggio allenamento:", e);
                showModal("Errore", "Impossibile salvare l'allenamento.", [{ text: "Ok", handler: () => {} }]);
            }
        }
        // FINE PARTE4A
// PARTE4B - Griglia Punteggio, Statistiche Live, Annotazioni Vol√©e e Salvataggio Sessioni
        function initializeScoringGrid() {
            const format = appState.currentSession.formatoGara;
            if (format.includes('3x10')) {
                scoringState.rows = 10;
                scoringState.cols = 3;
                scoringState.format = '3x10';
            } else if (format.includes('6x6')) {
                scoringState.rows = 6;
                scoringState.cols = 6;
                scoringState.format = '6x6';
            } else if (format.includes('6x12')) {
                scoringState.rows = 12;
                scoringState.cols = 6;
                scoringState.format = '6x12';
            }

            const turnKey = `turn${appState.currentTurn}`;
            if (!appState.currentSession[turnKey] || !appState.currentSession[turnKey].grid) {
                const grid = Array(scoringState.rows).fill(null).map(() => Array(scoringState.cols).fill(''));
                appState.currentSession[turnKey] = { grid: grid, summary: null, volleyNotes: {} };
            }

            appState.scoringGrid = appState.currentSession[turnKey].grid;
            appState.volleyNotes = appState.currentSession[turnKey].volleyNotes || {};
            scoringState.activeCell = { row: 1, col: 1 };

            // Calcola media personale per statistiche live
            calculatePersonalAverage();
        }

        async function calculatePersonalAverage() {
            try {
                const sessionsColRef = window.getSessionsCollectionRef();
                if (!sessionsColRef) return;

                const q = query(
                    sessionsColRef,
                    where('distanza', '==', appState.currentSession.distanza),
                    where('tipoTarga', '==', appState.currentSession.tipoTarga)
                );

                const querySnapshot = await getDocs(q);
                let totalScore = 0;
                let count = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.totalAverage && data.totalAverage > 0 && !data.trainingWithoutScore && !data.quickScore) {
                        totalScore += data.totalAverage;
                        count++;
                    }
                });

                scoringState.personalAverage = count > 0 ? (totalScore / count) : 0;
            } catch (error) {
                console.error("Errore calcolo media personale:", error);
                scoringState.personalAverage = 0;
            }
        }

        window.handleCellClick = (row, col) => {
            scoringState.activeCell = { row, col };
            renderScoringView();
        };

        window.handleKeypadInput = (value) => {
            const { row, col } = scoringState.activeCell;
            const rowIndex = row - 1;
            const colIndex = col - 1;

            if (rowIndex < 0 || rowIndex >= scoringState.rows || colIndex < 0 || colIndex >= scoringState.cols) {
                return;
            }

            if (value === 'CANC') {
                if (appState.scoringGrid[rowIndex][colIndex] !== '') {
                    appState.scoringGrid[rowIndex][colIndex] = '';
                } else {
                    let newCol = colIndex - 1;
                    let newRow = rowIndex;

                    if (newCol < 0) {
                        newRow = rowIndex - 1;
                        newCol = scoringState.cols - 1;
                    }

                    if (newRow >= 0) {
                        scoringState.activeCell = { row: newRow + 1, col: newCol + 1 };
                    }
                }
            } else {
                const scoreValue = (value === '10' ? '10' : value).toUpperCase();
                appState.scoringGrid[rowIndex][colIndex] = scoreValue;

                let newCol = colIndex + 1;
                let newRow = rowIndex;

                if (newCol >= scoringState.cols) {
                    newCol = 0;
                    newRow = rowIndex + 1;

                    const currentRow = appState.scoringGrid[rowIndex];
                    const nonEmptyScores = currentRow.filter(s => s !== '' && s !== undefined);
                    if (nonEmptyScores.length === scoringState.cols) {
                        appState.scoringGrid[rowIndex] = sortVolleyScores([...currentRow]);
                    }
                }

                if (newRow < scoringState.rows) {
                    scoringState.activeCell = { row: newRow + 1, col: newCol + 1 };
                }
            }

            renderScoringView();
        };

        window.addVolleyNote = (volleyNumber) => {
            const currentNote = appState.volleyNotes[volleyNumber] || '';
            
            const noteForm = document.createElement('div');
            noteForm.innerHTML = `
                <textarea id="volley-note-input" class="input-style h-24 w-full" placeholder="Inserisci nota per vol√©e ${volleyNumber}...">${currentNote}</textarea>
            `;

            showModal(
                `üìù Nota Vol√©e ${volleyNumber}`,
                noteForm,
                [
                    { text: "Annulla", handler: () => {} },
                    { text: "Salva", handler: () => {
                        const noteValue = document.getElementById('volley-note-input').value.trim();
                        if (noteValue) {
                            appState.volleyNotes[volleyNumber] = noteValue;
                        } else {
                            delete appState.volleyNotes[volleyNumber];
                        }
                        const turnKey = `turn${appState.currentTurn}`;
                        appState.currentSession[turnKey].volleyNotes = appState.volleyNotes;
                        renderScoringView();
                    }}
                ]
            );
        };

        function renderScoringView() {
            const session = appState.currentSession;
            const format = scoringState.format;
            const isTraining = session.type === 'Allenamento';

            let cumulativeTotalForView = 0;
            const gridData = appState.scoringGrid.map((row) => {
                const volleyResult = calculateVolley(row, cumulativeTotalForView);
                cumulativeTotalForView = volleyResult.totale; 
                return volleyResult;
            });

            // Calcola statistiche live
            const liveStats = calculateTurnScores(appState.scoringGrid);
            const totalArrows = scoringState.rows * scoringState.cols;
            const completedArrows = liveStats.frecceTirate;
            const remainingArrows = totalArrows - completedArrows;
            const currentAverage = liveStats.average;
            const projectedScore = remainingArrows > 0 ? 
                Math.round(liveStats.score + (remainingArrows * currentAverage)) : liveStats.score;
            const percentageComplete = ((completedArrows / totalArrows) * 100).toFixed(0);

            // Confronto con media personale
            const avgDifference = scoringState.personalAverage > 0 ? 
                (currentAverage - scoringState.personalAverage).toFixed(2) : null;

            const tableHtml = `
                <div class="grid-wrapper">
                    <table id="scoreTable" class="score-grid w-full table-fixed min-w-[500px] border-collapse">
                        <thead>
                            <tr class="text-xs sm:text-sm">
                                <th class="w-[10%]">Vol√©e</th>
                                ${Array(scoringState.cols).fill(0).map((_, i) => `<th class="w-[8%]">${i + 1}</th>`).join('')}
                                <th class="w-[10%]">Parz.</th>
                                <th class="w-[10%]">Tot.</th>
                                <th class="w-[12%]">X-10</th>
                                <th class="w-[8%]">9</th>
                                ${isTraining ? '<th class="w-[8%]">üìù</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${Array(scoringState.rows).fill(0).map((_, i) => {
                                const row = gridData[i];
                                const volleyNum = i + 1;
                                const isComplete = appState.scoringGrid[i].every(s => s !== '' && s !== undefined);
                                const hasNote = appState.volleyNotes[volleyNum];

                                return `
                                    <tr class="${i % 2 === 0 ? 'bg-secondary-dark' : 'bg-gray-800'} text-xs sm:text-base ${isComplete ? 'text-white' : 'text-primary-orange'}">
                                        <td class="font-bold">${volleyNum}</td>
                                        ${Array(scoringState.cols).fill(0).map((_, colIndex) => {
                                            const isActive = scoringState.activeCell.row === volleyNum && scoringState.activeCell.col === colIndex + 1;
                                            const score = appState.scoringGrid[i][colIndex];
                                            return `
                                                <td class="score-cell ${isActive ? 'bg-primary-orange text-black font-extrabold shadow-inner' : ''}" 
                                                    onclick="window.handleCellClick(${volleyNum}, ${colIndex + 1})">
                                                    ${score || ''}
                                                </td>
                                            `;
                                        }).join('')}
                                        <td class="font-bold text-white">${row.parziale || ''}</td>
                                        <td class="font-bold text-white">${row.totale || ''}</td>
                                        <td>${row.X10 || ''}</td>
                                        <td>${row.nine || ''}</td>
                                        ${isTraining ? `
                                            <td class="cursor-pointer hover:bg-primary-orange" onclick="window.addVolleyNote(${volleyNum})">
                                                ${hasNote ? 'üìù‚úì' : 'üìù'}
                                            </td>
                                        ` : ''}
                                    </tr>
                                    ${hasNote && isTraining ? `
                                        <tr class="bg-blue-900 bg-opacity-20">
                                            <td colspan="${scoringState.cols + 5}" class="text-xs text-left p-2 italic text-blue-200">
                                                üí¨ ${appState.volleyNotes[volleyNum]}
                                            </td>
                                        </tr>
                                    ` : ''}
                                `;
                            }).join('')}
                            ${(() => {
                                const totalResults = calculateTurnScores(appState.scoringGrid);
                                return `
                                    <tr class="bg-primary-orange text-black font-extrabold text-xs sm:text-base">
                                        <td colspan="${1 + scoringState.cols + 1}" class="text-right pr-4">Totale Turno</td>
                                        <td class="font-extrabold">${totalResults.score}</td>
                                        <td>${totalResults.X}-${totalResults.Ten}</td> 
                                        <td>${totalResults.Nine}</td>
                                        ${isTraining ? '<td></td>' : ''}
                                    </tr>
                                `;
                            })()}
                        </tbody>
                    </table>
                </div>
            `;

            // Statistiche Live Card
            const liveStatsHtml = completedArrows > 0 ? `
                <div class="stats-card mt-4">
                    <h3 class="text-xl font-bold mb-3 text-white flex items-center">
                        üìä Statistiche Live
                        <span class="ml-2 text-sm font-normal text-primary-orange">(${percentageComplete}% completato)</span>
                    </h3>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-primary-orange">Punteggio Attuale</div>
                            <div class="text-2xl font-bold text-white">${liveStats.score}</div>
                        </div>
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-primary-orange">Media Freccia</div>
                            <div class="text-2xl font-bold text-white">${currentAverage.toFixed(2)}</div>
                        </div>
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-primary-orange">Proiezione Finale</div>
                            <div class="text-2xl font-bold ${projectedScore >= liveStats.maxScore * 0.8 ? 'text-green-400' : 'text-white'}">${projectedScore}</div>
                        </div>
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-primary-orange">Frecce Rimanenti</div>
                            <div class="text-2xl font-bold text-white">${remainingArrows}</div>
                        </div>
                    </div>

                    ${avgDifference !== null && scoringState.personalAverage > 0 ? `
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-primary-orange mb-1">Confronto Media Personale</div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-white">Tua media: ${scoringState.personalAverage.toFixed(2)}</span>
                                <span class="text-lg font-bold ${avgDifference >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${avgDifference >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(avgDifference)}
                                </span>
                            </div>
                        </div>
                    ` : ''}

                    <div class="progress-bar mt-3">
                        <div class="progress-fill" style="width: ${percentageComplete}%"></div>
                    </div>
                    <div class="text-xs text-center mt-1 text-primary-orange">${completedArrows} / ${totalArrows} frecce</div>
                </div>
            ` : '';

            const keypadHtml = `
                <div class="mt-6">
                    <h3 class="text-xl font-bold mb-3 text-white">Tastierino Punteggi</h3>
                    <div class="grid grid-cols-4 gap-2 sm:grid-cols-5 md:grid-cols-7">
                        ${KEYPAD_VALUES.map(val => `
                            <button class="keypad-button bg-secondary-dark border-2 border-primary-orange text-white p-4 rounded-xl text-xl font-bold hover:bg-primary-orange hover:text-black active:scale-95"
                                    onclick="window.handleKeypadInput('${val}')">
                                ${val}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            // Riepilogo primo turno durante il secondo turno
            let turn1SummaryHtml = '';
            if (appState.currentTurn === 2 && appState.currentSession.turn1) {
                const turn1Data = appState.currentSession.turn1;
                const turn1Grid = turn1Data.grid;
                let cumulativeForTurn1 = 0;
                const turn1Volleys = turn1Grid.map((row) => {
                    const volleyResult = calculateVolley(row, cumulativeForTurn1);
                    cumulativeForTurn1 = volleyResult.totale;
                    return volleyResult;
                });

                turn1SummaryHtml = `
                    <div class="mt-6 bg-gray-900 p-4 rounded-xl border-2 border-primary-orange">
                        <h3 class="text-xl font-bold mb-3 text-primary-orange">üìã Riepilogo Primo Turno</h3>
                        <div class="grid-wrapper">
                            <table class="score-grid w-full table-auto min-w-[400px] border-collapse">
                                <thead>
                                    <tr class="text-xs">
                                        <th class="w-[15%]">Vol√©e</th>
                                        <th class="w-[45%]">Punteggi</th>
                                        <th class="w-[15%]">Parz.</th>
                                        <th class="w-[15%]">Tot.</th>
                                        <th class="w-[10%]">X-10</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${turn1Volleys.map((volley, i) => `
                                        <tr class="${i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-700'} text-xs">
                                            <td class="font-bold text-primary-orange">${i + 1}</td>
                                            <td class="text-white">${volley.scores.join(' - ')}</td>
                                            <td class="font-bold text-white">${volley.parziale}</td>
                                            <td class="font-bold text-white">${volley.totale}</td>
                                            <td class="text-primary-orange">${volley.X10}</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="bg-primary-orange text-black font-bold text-xs">
                                        <td colspan="2" class="text-right pr-2">Totale T1</td>
                                        <td>${turn1Data.summary.score}</td>
                                        <td>${turn1Data.summary.X}-${turn1Data.summary.Ten}</td>
                                        <td>9: ${turn1Data.summary.Nine}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            const sessionType = appState.sessionType;
            const actionsHtml = `
                <div class="mt-8 flex flex-col space-y-3">
                    ${(appState.currentTurn === 2 && format !== '6x12') || (format === '6x12' && appState.currentTurn === 1) ? `
                        <button class="btn-primary w-full p-3 rounded-lg text-lg" onclick="window.saveTurn(true)">
                            Fine ${sessionType} (Salva Risultati)
                        </button>
                    ` : `
                        <button class="btn-primary w-full p-3 rounded-lg text-lg" onclick="window.saveTurn(false)">
                            Salva Turno
                        </button>
                    `}
                    <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('registrationForm', { type: '${sessionType}' })">
                        Torna Indietro
                    </button>
                </div>
            `;

            document.getElementById('content-view').innerHTML = `
                <h2 class="text-3xl font-bold mb-4 text-white">${session.type} - Turno ${appState.currentTurn}</h2>
                <p class="text-sm mb-4">Distanza: ${session.distanza} | Formato: ${session.formatoGara}</p>
                ${tableHtml}
                ${keypadHtml}
                ${liveStatsHtml}
                ${turn1SummaryHtml}
                ${actionsHtml}
            `;
        }

        window.saveTurn = (isFinal) => {
            const turnKey = `turn${appState.currentTurn}`;
            const turnResults = calculateTurnScores(appState.scoringGrid);

            if (turnResults.frecceTirate !== (scoringState.rows * scoringState.cols)) {
                showModal("Turno Incompleto", "Non tutte le vol√©e hanno frecce. Salvare comunque?", [
                    { text: "Annulla", handler: () => {} },
                    { text: "Salva", handler: () => confirmSave(isFinal, turnKey, turnResults) }
                ]);
            } else {
                confirmSave(isFinal, turnKey, turnResults);
            }
        };

        function confirmSave(isFinal, turnKey, turnResults) {
            appState.currentSession[turnKey].summary = turnResults;
            appState.currentSession[turnKey].volleyNotes = appState.volleyNotes;

            let modalBody = `
                <p class="text-lg font-bold mb-3 text-white">Riepilogo Turno ${appState.currentTurn}</p>
                <ul class="space-y-1 text-sm">
                    <li><strong>Punteggio:</strong> <span class="text-primary-orange font-bold">${turnResults.score}</span> / ${turnResults.maxScore}</li>
                    <li><strong>Media:</strong> <span class="text-primary-orange font-bold">${turnResults.average.toFixed(2)}</span></li>
                    <li><strong>X:</strong> ${turnResults.X} | <strong>10:</strong> ${turnResults.Ten} | <strong>9:</strong> ${turnResults.Nine}</li>
                </ul>
            `;

            const format = appState.currentSession.formatoGara;

            if (isFinal) {
                const endTime = new Date();
                appState.currentSession.endTime = getFormattedTime(endTime);
                appState.currentSession.duration = calculateDuration(appState.currentSession.startTime, appState.currentSession.endTime);

                const sessionIdBeforeSave = appState.currentSession.id;
                saveSessionToFirestore();

                modalBody += `<p class="mt-4 text-white">Sessione completata. Durata: ${durationToString(appState.currentSession.duration)}.</p>`;

                showModal("Turno Salvato!", modalBody, [
                    { text: "Vedi Riepilogo", handler: () => {
                        setTimeout(() => {
                            fetchSessions();
                            setTimeout(() => {
                                window.setView('detailedSummary', { sessionId: sessionIdBeforeSave });
                            }, 500);
                        }, 300);
                    }}
                ]);
            } else if (appState.currentTurn === 1 && format !== '72 frecce (6x12)') {
                showModal("Turno Salvato!", modalBody, [
                    { text: "Secondo Turno", handler: () => startNextTurn() },
                    { text: "Fine e Vedi Riepilogo", handler: () => {
                        closeModal();
                        const endTime = new Date();
                        appState.currentSession.endTime = getFormattedTime(endTime);
                        appState.currentSession.duration = calculateDuration(appState.currentSession.startTime, appState.currentSession.endTime);

                        const sessionIdBeforeSave = appState.currentSession.id;
                        saveSessionToFirestore();

                        setTimeout(() => {
                            fetchSessions();
                            setTimeout(() => {
                                window.setView('detailedSummary', { sessionId: sessionIdBeforeSave });
                            }, 500);
                        }, 300);
                    }}
                ]);
            } else {
                const endTime = new Date();
                appState.currentSession.endTime = getFormattedTime(endTime);
                appState.currentSession.duration = calculateDuration(appState.currentSession.startTime, appState.currentSession.endTime);

                const sessionIdBeforeSave = appState.currentSession.id;
                saveSessionToFirestore();

                modalBody += `<p class="mt-4 text-white">Completata. Durata: ${durationToString(appState.currentSession.duration)}.</p>`;

                showModal("Turno Salvato!", modalBody, [
                    { text: "Vedi Riepilogo", handler: () => {
                        setTimeout(() => {
                            fetchSessions();
                            setTimeout(() => {
                                window.setView('detailedSummary', { sessionId: sessionIdBeforeSave });
                            }, 500);
                        }, 300);
                    }}
                ]);
            }
        }

        function startNextTurn() {
            if (appState.currentTurn === 1) {
                appState.currentTurn = 2;
            }
            window.setView('scoring');
        }

        function calculateDuration(startTimeStr, endTimeStr) {
            const date = new Date().toISOString().split('T')[0];
            const start = new Date(`${date}T${startTimeStr}`);
            const end = new Date(`${date}T${endTimeStr}`);

            if (end < start) {
                end.setDate(end.getDate() + 1);
            }

            const diffMs = end - start;
            return Math.round(diffMs / (1000 * 60));
        }

        function prepareTurnData(turn) {
            if (!turn || !turn.grid) return null;

            const serializedGrid = turn.grid.map(row => JSON.stringify(row));

            return {
                summary: turn.summary,
                grid: serializedGrid,
                volleyNotes: turn.volleyNotes || {}
            };
        }

        async function saveSessionToFirestore() {
            try {
                const session = appState.currentSession;
                const results = calculateTotalSessionResults(session);

                const turn1Data = prepareTurnData(session.turn1);
                const turn2Data = session.turn2 ? prepareTurnData(session.turn2) : null;

                const finalSessionData = {
                    ...session,
                    ...results,
                    timestamp: serverTimestamp(),
                    archerId: appState.loggedInArcher.id,
                    arciere: appState.loggedInArcher.nome,
                    turn1: turn1Data,
                    turn2: turn2Data,
                };

                const docRef = await addDoc(window.getSessionsCollectionRef(), finalSessionData);
                console.log("Sessione salvata con ID:", docRef.id);

                appState.currentSession = null;
                appState.currentTurn = 1;
                appState.volleyNotes = {};
            } catch (e) {
                console.error("Errore salvataggio:", e);
                showModal("Errore", "Impossibile salvare la sessione.", [{ text: "Ok", handler: () => {} }]);
            }
        }

        function calculateTotalSessionResults(session) {
            const turn1Summary = session.turn1?.summary || { score: 0, X: 0, Ten: 0, Nine: 0, frecceTirate: 0, average: 0 };
            const turn2Summary = session.turn2?.summary || { score: 0, X: 0, Ten: 0, Nine: 0, frecceTirate: 0, average: 0 };

            const totalScore = turn1Summary.score + turn2Summary.score;
            const totalShots = turn1Summary.frecceTirate + turn2Summary.frecceTirate;

            return {
                totalScore: totalScore,
                totalX: turn1Summary.X + turn2Summary.X,
                totalTen: turn1Summary.Ten + turn2Summary.Ten,
                totalNine: turn1Summary.Nine + turn2Summary.Nine,
                totalAverage: totalShots > 0 ? (totalScore / totalShots) : 0,
                turn1Score: turn1Summary.score,
                turn1Average: turn1Summary.average,
                turn2Score: turn2Summary.score,
                turn2Average: turn2Summary.average, 
            };
        }
        // FINE PARTE4B
 // PARTE4C - Riepilogo Dati e Visualizzazione Dettagliata
        let unsubscribeSnapshot = null;
        let filterState = {
            distanza: '',
            tipoTarga: '',
            type: '',
            tipoLuogo: '',
            anno: '',
        };
        const ANNO_OPTIONS = [2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032, 2033, 2034, 2035];

        function fetchSessions() {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
            }

            const sessionsColRef = window.getSessionsCollectionRef();
            if (!sessionsColRef) {
                console.error("Riferimento collezione non disponibile.");
                return;
            }

            let q = query(sessionsColRef);
            if (filterState.distanza) q = query(q, where('distanza', '==', filterState.distanza));
            if (filterState.tipoTarga) q = query(q, where('tipoTarga', '==', filterState.tipoTarga));
            if (filterState.type) q = query(q, where('type', '==', filterState.type));
            if (filterState.tipoLuogo) q = query(q, where('tipoLuogo', '==', filterState.tipoLuogo));
            if (filterState.anno) {
                const startDate = `${filterState.anno}-01-01`;
                const endDate = `${filterState.anno}-12-31`;
                q = query(q, where('data', '>=', startDate), where('data', '<=', endDate));
            }

            unsubscribeSnapshot = onSnapshot(q, (querySnapshot) => {
                const sessions = [];
                querySnapshot.forEach((doc) => {
                    sessions.push({ docId: doc.id, ...doc.data() }); 
                });
                sessions.sort((a, b) => new Date(a.data) - new Date(b.data));
                appState.sessionData = sessions;
                renderDataSummaryTable();
            }, (error) => {
                console.error("Errore onSnapshot:", error);
            });
        }

        window.handleFilterChange = (field, value) => {
            filterState[field] = value;
            fetchSessions();
        };

        function renderDataSummary() {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            const filtersHtml = `
                <div class="mb-6 p-4 bg-secondary-dark rounded-xl shadow-lg grid grid-cols-2 gap-3 md:grid-cols-6">
                    <select class="input-style text-sm" onchange="window.handleFilterChange('type', this.value)">
                        <option value="">Tutti i Tipi</option>
                        <option value="Allenamento" ${filterState.type === 'Allenamento' ? 'selected' : ''}>Allenamento</option>
                        <option value="Gara" ${filterState.type === 'Gara' ? 'selected' : ''}>Gara</option>
                    </select>
                    <select class="input-style text-sm" onchange="window.handleFilterChange('distanza', this.value)">
                        <option value="">Tutte le Distanze</option>
                        ${DISTANZA_OPTIONS.map(opt => `<option value="${opt}" ${filterState.distanza === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                    <select class="input-style text-sm" onchange="window.handleFilterChange('tipoTarga', this.value)">
                        <option value="">Tutte le Targhe</option>
                        ${TIPO_TARGA_OPTIONS.map(opt => `<option value="${opt}" ${filterState.tipoTarga === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                    <select class="input-style text-sm" onchange="window.handleFilterChange('tipoLuogo', this.value)">
                        <option value="">Tutti i Luoghi</option>
                        ${TIPO_LUOGO_OPTIONS.map(opt => `<option value="${opt}" ${filterState.tipoLuogo === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                    <select class="input-style text-sm" onchange="window.handleFilterChange('anno', this.value)">
                        <option value="">Tutti gli Anni</option>
                        ${ANNO_OPTIONS.map(opt => `<option value="${opt}" ${filterState.anno === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                    <button class="btn-primary p-2 text-sm" onclick="window.handleFilterChange('type', ''); window.handleFilterChange('distanza', ''); window.handleFilterChange('tipoTarga', ''); window.handleFilterChange('tipoLuogo', ''); window.handleFilterChange('anno', '');">Reset</button>
                </div>
            `;

            const tableContainer = `<div id="dataSummaryTable" class="grid-wrapper"></div>`;

            document.getElementById('content-view').innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-white">Riepilogo Dati - ${appState.loggedInArcher.nome}</h2>
                ${filtersHtml}
                ${tableContainer}
                <button class="btn-primary w-full p-3 rounded-lg mt-6 bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                    Torna al Menu
                </button>
            `;

            renderDataSummaryTable();
        }

        function renderDataSummaryTable() {
            const tableContainer = document.getElementById('dataSummaryTable');
            if (!tableContainer) return;

            const tableHtml = `
                <table class="score-grid w-full table-auto min-w-[800px] border-collapse">
                    <thead>
                        <tr class="text-xs sm:text-sm">
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Tot.</th>
                            <th>T1</th>
                            <th>T2</th>
                            <th>X</th>
                            <th>10</th>
                            <th>9</th>
                            <th>Luogo</th>
                            <th>Distanza</th>
                            <th>Targa</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appState.sessionData.length === 0 ? `
                            <tr><td colspan="11" class="p-4 text-center">Nessuna sessione trovata.</td></tr>
                        ` : appState.sessionData.map(session => {
                            const isTrainingWithoutScore = session.trainingWithoutScore === true;
                            const isQuickScore = session.quickScore === true;
                            return `
                            <tr class="${session.type === 'Gara' ? 'bg-orange-900 bg-opacity-30' : isTrainingWithoutScore ? 'bg-blue-900 bg-opacity-30' : isQuickScore ? 'bg-purple-900 bg-opacity-30' : 'bg-gray-800'} hover:bg-secondary-dark cursor-pointer text-xs sm:text-sm"
                                onclick="window.setView('detailedSummary', { sessionId: '${session.id}' })">
                                <td class="font-bold text-primary-orange">${formatDate(session.data)}</td>
                                <td>${session.type}${isTrainingWithoutScore ? ' üéì' : isQuickScore ? ' ‚ö°' : ''}</td>
                                <td class="font-extrabold text-white">${isTrainingWithoutScore ? '-' : (session.totalScore || 0)}</td>
                                <td>${isTrainingWithoutScore ? '-' : (session.turn1Score || 0)}</td>
                                <td>${isTrainingWithoutScore ? '-' : (session.turn2Score || 0)}</td>
                                <td>${isTrainingWithoutScore || isQuickScore ? '-' : (session.totalX || 0)}</td>
                                <td>${isTrainingWithoutScore || isQuickScore ? '-' : (session.totalTen || 0)}</td>
                                <td>${isTrainingWithoutScore || isQuickScore ? '-' : (session.totalNine || 0)}</td>
                                <td>${session.luogo}</td>
                                <td>${session.distanza || '-'}</td>
                                <td>${session.tipoTarga || '-'}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
            tableContainer.innerHTML = tableHtml;
        }

        function renderDetailedSummary() {
            const session = appState.detailedSession;
            if (!session) {
                window.setView('dataSummary');
                return;
            }

            const isTrainingWithoutScore = session.trainingWithoutScore === true;
            const isQuickScore = session.quickScore === true;
            const hasTurn2 = session.turn2 && session.turn2.summary && session.turn2.summary.score > 0;

            if (isTrainingWithoutScore) {
                const html = `
                    <h2 class="text-3xl font-bold mb-4 text-white">Allenamento Tecnico del ${formatDate(session.data)}</h2>
                    <p class="text-xl mb-6 text-primary-orange">${session.luogo} (${session.tipoLuogo})</p>
                    <div class="space-y-6">
                        <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border border-primary-orange">
                            <h3 class="text-2xl font-bold mb-3 text-white">Informazioni Sessione</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>Data:</strong> ${formatDate(session.data)}</div>
                                <div><strong>Ora Inizio:</strong> ${session.startTime}</div>
                                <div><strong>Ora Fine:</strong> ${session.endTime}</div>
                                <div><strong>Durata:</strong> ${durationToString(session.duration)}</div>
                                <div><strong>Luogo:</strong> ${session.luogo}</div>
                                <div><strong>Tipo Luogo:</strong> ${session.tipoLuogo}</div>
                            </div>
                        </div>
                        ${session.note ? `
                            <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border border-primary-orange">
                                <h3 class="text-xl font-bold mb-3 text-white">Note</h3>
                                <p class="text-white whitespace-pre-wrap">${session.note}</p>
                            </div>
                        ` : ''}
                        <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border-2 border-primary-orange">
                            <h3 class="text-2xl font-bold mb-3 text-white">Contenuto Allenamento</h3>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <p class="text-white whitespace-pre-wrap">${session.trainingContent || 'Nessun contenuto inserito.'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 space-y-3">
                        <button class="btn-primary w-full p-3 rounded-lg" onclick="window.setView('editNotes', { sessionId: '${session.id}' })">
                            üìù Modifica Note
                        </button>
                        <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                            üè† Torna al Menu Principale
                        </button>
                        <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('dataSummary')">
                            Torna al Riepilogo
                        </button>
                        <button class="bg-red-600 hover:bg-red-700 text-white w-full p-3 rounded-lg font-bold shadow-lg" onclick="window.showDeleteSessionSection('${session.docId}', '${formatDate(session.data)}')">
                            üóëÔ∏è Elimina Questa Sessione
                        </button>
                    </div>
                `;
                document.getElementById('content-view').innerHTML = html;
            } else if (isQuickScore) {
                const html = `
                    <h2 class="text-3xl font-bold mb-4 text-white">‚ö° ${session.type} del ${formatDate(session.data)} (Quick Score)</h2>
                    <p class="text-xl mb-6 text-primary-orange">${session.distanza} | ${session.tipoTarga}</p>
                    <div class="space-y-6">
                        <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border border-primary-orange">
                            <h3 class="text-2xl font-bold mb-3 text-white">Statistiche Generali</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>Durata:</strong> ${durationToString(session.duration)}</div>
                                <div><strong>Luogo:</strong> ${session.luogo} (${session.tipoLuogo})</div>
                                <div><strong>Formato:</strong> ${session.formatoGara}</div>
                                <div><strong>Modalit√†:</strong> Quick Score ‚ö°</div>
                            </div>
                        </div>
                        <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border-2 border-purple-500">
                            <h3 class="text-2xl font-bold mb-3 text-white">Punteggi</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="bg-gray-800 p-4 rounded-lg text-center">
                                    <div class="text-xs text-primary-orange mb-1">Turno 1</div>
                                    <div class="text-3xl font-bold text-white">${session.quickScoreTurn1 || 0}</div>
                                </div>
                                ${session.quickScoreTurn2 > 0 ? `
                                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                                        <div class="text-xs text-primary-orange mb-1">Turno 2</div>
                                        <div class="text-3xl font-bold text-white">${session.quickScoreTurn2}</div>
                                    </div>
                                ` : ''}
                                <div class="bg-primary-orange p-4 rounded-lg text-center">
                                    <div class="text-xs text-black mb-1">TOTALE</div>
                                    <div class="text-3xl font-bold text-black">${session.totalScore}</div>
                                </div>
                            </div>
                        </div>
                        ${session.note ? `
                            <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border border-primary-orange">
                                <h3 class="text-xl font-bold mb-3 text-white">Note</h3>
                                <p class="text-white whitespace-pre-wrap">${session.note}</p>
                            </div>
                        ` : ''}
                        <div class="bg-yellow-900 bg-opacity-30 p-4 rounded-xl border border-yellow-500">
                            <p class="text-sm text-yellow-200">
                                ‚ÑπÔ∏è Questa sessione √® stata registrata con Quick Score. 
                                Non sono disponibili dettagli per singola freccia o vol√©e.
                            </p>
                        </div>
                    </div>
                    <div class="mt-8 space-y-3">
                        <button class="btn-primary w-full p-3 rounded-lg" onclick="window.setView('editNotes', { sessionId: '${session.id}' })">
                            üìù Modifica Note
                        </button>
                        <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                            üè† Torna al Menu Principale
                        </button>
                        <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('dataSummary')">
                            Torna al Riepilogo
                        </button>
                        <button class="bg-red-600 hover:bg-red-700 text-white w-full p-3 rounded-lg font-bold shadow-lg" onclick="window.showDeleteSessionSection('${session.docId}', '${formatDate(session.data)}')">
                            üóëÔ∏è Elimina Questa Sessione
                        </button>
                    </div>
                `;
                document.getElementById('content-view').innerHTML = html;
            } else {
                const html = `
                    <h2 class="text-3xl font-bold mb-4 text-white">${session.type} del ${formatDate(session.data)}</h2>
                    <p class="text-xl mb-6 text-primary-orange">${session.distanza} | ${session.tipoTarga}</p>
                    <div class="space-y-6">
                        <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border border-primary-orange">
                            <h3 class="text-2xl font-bold mb-3 text-white">Statistiche Generali</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>Durata:</strong> ${durationToString(session.duration)}</div>
                                <div><strong>Luogo:</strong> ${session.luogo} (${session.tipoLuogo})</div>
                                <div><strong>Punteggio:</strong> <span class="text-white font-extrabold">${session.totalScore}</span></div>
                                <div><strong>Media:</strong> <span class="text-white font-extrabold">${session.totalAverage.toFixed(2)}</span></div>
                            </div>
                            <div class="mt-3 p-2 bg-gray-800 rounded-lg">
                                <strong>X-10/9:</strong> 
                                <span class="text-white font-extrabold">${session.totalX}-${session.totalTen}</span> / 9: ${session.totalNine}
                            </div>
                        </div>
                        ${session.note ? `
                            <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border border-primary-orange">
                                <h3 class="text-xl font-bold mb-3 text-white">Note</h3>
                                <p class="text-white whitespace-pre-wrap">${session.note}</p>
                            </div>
                        ` : ''}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${renderTurnSummaryCard(session.turn1, 'Primo Turno')}
                            ${hasTurn2 ? renderTurnSummaryCard(session.turn2, 'Secondo Turno') : ''}
                        </div>
                        <h3 class="text-2xl font-bold mb-3 mt-8 text-white">Segnapunti Dettagliato</h3>
                        ${renderDetailedScoreGrid(session.turn1, 'Primo Turno', session.type === 'Allenamento')}
                        ${hasTurn2 ? renderDetailedScoreGrid(session.turn2, 'Secondo Turno', session.type === 'Allenamento') : ''}
                    </div>
                    <div class="mt-8 space-y-3">
                        <button class="btn-primary w-full p-3 rounded-lg" onclick="window.setView('editNotes', { sessionId: '${session.id}' })">
                            üìù Modifica Note
                        </button>
                        <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                            üè† Torna al Menu Principale
                        </button>
                        <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('dataSummary')">
                            Torna al Riepilogo
                        </button>
                        <button class="bg-red-600 hover:bg-red-700 text-white w-full p-3 rounded-lg font-bold shadow-lg" onclick="window.showDeleteSessionSection('${session.docId}', '${formatDate(session.data)}')">
                            üóëÔ∏è Elimina Questa Sessione
                        </button>
                    </div>
                `;
                document.getElementById('content-view').innerHTML = html;
            }
        }

        window.showDeleteSessionSection = (sessionId, sessionDate) => {
            if (!appState.loggedInArcher) {
                showModal("Errore", "Devi essere loggato per eliminare sessioni.", [
                    { text: "Ok", handler: () => {} }
                ]);
                return;
            }

            const html = `
                <div class="max-w-md mx-auto">
                    <button class="text-primary-orange underline mb-4" onclick="window.setView('detailedSummary', { sessionId: '${sessionId}' })">
                        ‚Üê Torna alla Sessione
                    </button>
                    <h2 class="text-3xl font-bold mb-4 text-white text-center">Elimina Sessione</h2>
                    <p class="text-center mb-4 text-white">Stai per eliminare la sessione del <strong class="text-primary-orange">${sessionDate}</strong></p>
                    <p class="text-center mb-6 text-red-500 font-bold">‚ö†Ô∏è ATTENZIONE: Questa azione √® irreversibile!</p>
                    <form id="deleteSessionForm" class="space-y-4 bg-secondary-dark p-6 rounded-xl shadow-lg border-2 border-red-600">
                        <div>
                            <label class="block text-sm font-medium mb-1 text-white">Conferma con la tua Password</label>
                            <input type="password" id="delete-session-password" class="input-style" required placeholder="Inserisci password per confermare" autofocus>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg font-bold" onclick="window.setView('detailedSummary', { sessionId: '${sessionId}' })">
                                Annulla
                            </button>
                            <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg font-bold">
                                Elimina Definitivamente
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('content-view').innerHTML = html;

            document.getElementById('deleteSessionForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const password = document.getElementById('delete-session-password').value;

                if (!password) {
                    showModal("Errore", "Inserisci la password per confermare.", [{ text: "Ok", handler: () => {} }]);
                    return;
                }

                if (password !== MASTER_PASSWORD && password !== appState.loggedInArcher.password) {
                    showModal("Errore", "Password errata. Impossibile eliminare la sessione.", [{ text: "Ok", handler: () => {} }]);
                    return;
                }

                try {
                    const archerId = appState.loggedInArcher.id;
                    const sessionDocRef = doc(db, "artifacts", appId, "archers", archerId, "sessions", sessionId);
                    await deleteDoc(sessionDocRef);
                    appState.detailedSession = null;
                    showModal("Successo", "La sessione √® stata eliminata con successo.", [
                        { text: "Ok", handler: () => { window.setView('dataSummary'); }}
                    ]);
                } catch (error) {
                    console.error("Errore eliminazione:", error);
                    showModal("Errore", `Impossibile eliminare: ${error.message}`, [{ text: "Ok", handler: () => {} }]);
                }
            });
        };

        function renderTurnSummaryCard(turn, title) {
            const summary = turn.summary;
            if (!summary) return '';
            return `
                <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border border-primary-orange">
                    <h4 class="text-xl font-bold mb-2 text-white">${title}</h4>
                    <ul class="space-y-1 text-sm">
                        <li><strong>Punteggio:</strong> <span class="text-white font-extrabold">${summary.score}</span> / ${summary.maxScore}</li>
                        <li><strong>Media:</strong> ${summary.average.toFixed(2)}</li>
                        <li><strong>X-10/9:</strong> <span class="text-white font-extrabold">${summary.X}-${summary.Ten}</span>, 9: ${summary.Nine}</li>
                    </ul>
                </div>
            `;
        }

        function deserializeGrid(turn) {
            if (!turn || !turn.grid || turn.grid.length === 0) return [];
            return turn.grid.map(rowStr => JSON.parse(rowStr));
        }

        function renderDetailedScoreGrid(turn, title, isTraining = false) {
            const grid2D = deserializeGrid(turn); 
            let cumulativeTotalForView = 0;
            const volleys = grid2D.map(row => {
                const volleyResult = calculateVolley(row, cumulativeTotalForView);
                cumulativeTotalForView = volleyResult.totale; 
                return volleyResult;
            });

            if (!volleys || volleys.length === 0) return '';

            const numCols = volleys[0].scores.length;
            const volleyNotes = turn.volleyNotes || {};

            const tableHtml = `
                <div class="mt-4">
                    <h4 class="text-lg font-bold mb-2 text-primary-orange">${title}</h4>
                    <div class="grid-wrapper">
                        <table class="score-grid w-full table-auto min-w-[500px] border-collapse">
                            <thead>
                                <tr class="text-xs sm:text-sm">
                                    <th class="w-[10%]">Vol√©e</th>
                                    ${Array(numCols).fill(0).map((_, i) => `<th class="w-[8%]">${i + 1}</th>`).join('')}
                                    <th class="w-[10%]">Parz.</th>
                                    <th class="w-[10%]">Tot.</th>
                                    <th class="w-[12%]">X-10</th>
                                    <th class="w-[8%]">9</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${volleys.map((row, i) => {
                                    const volleyNum = i + 1;
                                    const hasNote = volleyNotes[volleyNum];
                                    return `
                                    <tr class="${i % 2 === 0 ? 'bg-secondary-dark' : 'bg-gray-800'} hover:bg-gray-700 text-xs sm:text-sm">
                                        <td class="font-bold">${volleyNum}${hasNote ? ' üìù' : ''}</td>
                                        ${row.scores.map(score => `<td>${score || ''}</td>`).join('')}
                                        <td class="font-bold text-white">${row.parziale}</td>
                                        <td class="font-bold text-white">${row.totale}</td>
                                        <td>${row.X10}</td>
                                        <td>${row.nine}</td>
                                    </tr>
                                    ${hasNote ? `
                                        <tr class="bg-blue-900 bg-opacity-20">
                                            <td colspan="${numCols + 5}" class="text-xs text-left p-2 italic text-blue-200">
                                                üí¨ ${volleyNotes[volleyNum]}
                                            </td>
                                        </tr>
                                    ` : ''}
                                `}).join('')}
                                <tr class="bg-primary-orange text-black font-extrabold text-xs sm:text-sm">
                                    <td colspan="${1 + numCols + 1}" class="text-right pr-4">Totale</td>
                                    <td>${turn.summary.score}</td>
                                    <td>${turn.summary.X}-${turn.summary.Ten}</td>
                                    <td>${turn.summary.Nine}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return tableHtml;
        }

        function renderEditNotes(sessionId) {
            const session = appState.sessionData.find(s => String(s.id) === String(sessionId));
            
            if (!session) {
                window.setView('dataSummary');
                return;
            }
            
            const currentNote = session.note || '';
            const isTrainingWithoutScore = session.trainingWithoutScore === true;
            const currentTrainingContent = session.trainingContent || '';
            
            const html = `
                <div class="max-w-2xl mx-auto">
                    <button class="text-primary-orange underline mb-4" onclick="window.setView('detailedSummary', { sessionId: '${session.id}' })">
                        ‚Üê Torna alla Sessione
                    </button>
                    
                    <h2 class="text-3xl font-bold mb-4 text-white text-center">Modifica Note</h2>
<p class="text-center mb-6 text-primary-orange">Sessione del ${formatDate(session.data)}</p>
 <form id="editNotesForm" class="space-y-6 bg-secondary-dark p-6 rounded-xl shadow-lg">
                    <div>
                        <label for="session-note" class="block text-lg font-medium mb-2 text-white">
                            Note Generali
                        </label>
                        <textarea id="session-note" name="note" 
                                  class="input-style h-32" 
                                  placeholder="Aggiungi note generali sulla sessione...">${currentNote}</textarea>
                        <p class="text-xs text-primary-orange mt-1">Note visibili in tutte le sessioni</p>
                    </div>
                    
                    ${isTrainingWithoutScore ? `
                        <div>
                            <label for="training-content" class="block text-lg font-medium mb-2 text-white">
                                Contenuto Allenamento Tecnico
                            </label>
                            <textarea id="training-content" name="trainingContent" 
                                      class="input-style h-64" 
                                      placeholder="Descrivi gli esercizi svolti, tecniche praticate, obiettivi raggiunti...">${currentTrainingContent}</textarea>
                            <p class="text-xs text-primary-orange mt-1">Dettagli specifici dell'allenamento tecnico</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-3">
                        <button type="button" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg font-bold" 
                                onclick="window.setView('detailedSummary', { sessionId: '${session.id}' })">
                            Annulla
                        </button>
                        <button type="submit" class="flex-1 btn-primary p-3 rounded-lg">
                            üíæ Salva Modifiche
                        </button>
                    </div>
                </form>
            </div>
        `;
        
        document.getElementById('content-view').innerHTML = html;
        
        document.getElementById('editNotesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newNote = document.getElementById('session-note').value.trim();
            const newTrainingContent = isTrainingWithoutScore ? 
                document.getElementById('training-content').value.trim() : null;
            
            try {
                const archerId = appState.loggedInArcher.id;
                const sessionDocRef = doc(db, "artifacts", appId, "archers", archerId, "sessions", session.docId);
                
                const updateData = { note: newNote };
                
                if (isTrainingWithoutScore && newTrainingContent !== null) {
                    updateData.trainingContent = newTrainingContent;
                }
                
                await updateDoc(sessionDocRef, updateData);
                
                session.note = newNote;
                if (isTrainingWithoutScore) {
                    session.trainingContent = newTrainingContent;
                }
                
                showModal("Successo", "Le note sono state aggiornate con successo!", [
                    { text: "Ok", handler: () => { window.setView('detailedSummary', { sessionId: session.id }); }}
                ]);
                
            } catch (error) {
                console.error("Errore aggiornamento note:", error);
                showModal("Errore", `Impossibile aggiornare le note: ${error.message}`, [
                    { text: "Ok", handler: () => {} }
                ]);
            }
        });
    }
    // FINE PARTE4C
// PARTE4D - FINALE - Grafici e Chiusura

        function renderChartsView() {
            const html = `
                <h2 class="text-3xl font-bold mb-6 text-white">Grafici Andamento</h2>
                <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                    <h3 class="text-xl font-bold mb-4 text-primary-orange">Filtri</h3>
                    <div class="grid grid-cols-2 gap-3 md:grid-cols-4">
                        
                        <select id="chart-filter-type" class="input-style text-sm">
                            <option value="all">Tutti i Tipi (A/G)</option>
                            <option value="allenamento">Allenamento</option>
                            <option value="gara">Gara</option>
                        </select>
                        <select id="chart-filter-distance" class="input-style text-sm">
                            <option value="all">Tutte le Distanze</option>
                            ${DISTANZA_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                        <select id="chart-filter-target" class="input-style text-sm">
                            <option value="all">Tutte le Targhe</option>
                            ${TIPO_TARGA_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                        <select id="chart-filter-location" class="input-style text-sm">
                            <option value="all">Tutti i Luoghi</option>
                            ${TIPO_LUOGO_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                        
                        <select id="chart-filter-month" class="input-style text-sm">
                            <option value="all">Tutti i Mesi</option>
                            <option value="1">Gennaio</option>
                            <option value="2">Febbraio</option>
                            <option value="3">Marzo</option>
                            <option value="4">Aprile</option>
                            <option value="5">Maggio</option>
                            <option value="6">Giugno</option>
                            <option value="7">Luglio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Settembre</option>
                            <option value="10">Ottobre</option>
                            <option value="11">Novembre</option>
                            <option value="12">Dicembre</option>
                        </select>
                        <select id="chart-filter-year" class="input-style text-sm">
                            <option value="all">Tutti gli Anni</option>
                        </select>
                        <select id="chart-filter-turns" class="input-style text-sm">
                            <option value="all">Tutti i Turni</option>
                            <option value="single">Solo 1 Turno</option>
                            <option value="double">Solo 2 Turni</option>
                        </select>
                        
                        <button class="btn-primary p-2 text-sm" onclick="window.resetChartFilters()">Reset</button>
                    </div>
                </div>
                <div class="bg-secondary-dark p-4 rounded-xl shadow-lg" style="height: 400px;">
                    <canvas id="sessionsChart"></canvas>
                </div>
                <button class="btn-primary w-full p-3 rounded-lg mt-6 bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                    Torna al Menu Principale
                </button>
            `;
            document.getElementById('content-view').innerHTML = html;
            
            loadChartsData();
        }

        window.resetChartFilters = () => {
            document.getElementById('chart-filter-type').value = 'all';
            document.getElementById('chart-filter-distance').value = 'all';
            document.getElementById('chart-filter-target').value = 'all';
            document.getElementById('chart-filter-location').value = 'all';
            document.getElementById('chart-filter-month').value = 'all';
            document.getElementById('chart-filter-year').value = 'all';
            document.getElementById('chart-filter-turns').value = 'all';
            drawSessionsChart();
        };

        function loadChartsData() {
            const sessionsColRef = window.getSessionsCollectionRef();
            if (!sessionsColRef) {
                console.error("Riferimento collezione non disponibile.");
                return;
            }

            const q = query(sessionsColRef);
            
            getDocs(q).then((querySnapshot) => {
                const sessions = [];
                querySnapshot.forEach((doc) => {
                    sessions.push({ id: doc.id, ...doc.data() });
                });
                
                sessions.sort((a, b) => new Date(a.data) - new Date(b.data));
                appState.sessionData = sessions;
                
                setupChartFilters();
                drawSessionsChart();
            }).catch((error) => {
                console.error("Errore nel caricamento dei dati:", error);
            });
        }

        function setupChartFilters() {
            ['chart-filter-type', 'chart-filter-target', 'chart-filter-distance', 'chart-filter-location', 'chart-filter-month', 'chart-filter-year', 'chart-filter-turns'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', drawSessionsChart);
                }
            });

            const yearFilter = document.getElementById('chart-filter-year');
            if (yearFilter) {
                const years = new Set();
                appState.sessionData.forEach(session => {
                    if (session.data) {
                        years.add(new Date(session.data).getFullYear());
                    }
                });

                Array.from(yearFilter.options).forEach((option, index) => {
                    if (index > 0) yearFilter.removeChild(option);
                });

                Array.from(years).sort((a, b) => b - a).forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
            }
        }

        function drawSessionsChart() {
            const ctx = document.getElementById('sessionsChart');
            if (!ctx) return;
            
            const context = ctx.getContext('2d');
            
            const typeFilter = document.getElementById('chart-filter-type').value;
            const targetFilter = document.getElementById('chart-filter-target').value;
            const distanceFilter = document.getElementById('chart-filter-distance').value;
            const locationFilter = document.getElementById('chart-filter-location').value;
            const monthFilter = document.getElementById('chart-filter-month').value;
            const yearFilter = document.getElementById('chart-filter-year').value;
            const turnsFilter = document.getElementById('chart-filter-turns').value;

            let filteredData = appState.sessionData.filter(session => {
                const sType = (session.type || '').toLowerCase();
                const sTargetType = (session.tipoTarga || '');
                const sDistance = (session.distanza || '');
                const sLocation = (session.tipoLuogo || '');
                
                const sessionDate = session.data ? new Date(session.data) : null;
                const sMonth = sessionDate ? sessionDate.getMonth() + 1 : null;
                const sYear = sessionDate ? sessionDate.getFullYear() : null;
                const hasTwoTurns = session.turn2Score > 0; 
                
                const matchesType = typeFilter === 'all' || sType === typeFilter;
                const matchesTarget = targetFilter === 'all' || sTargetType === targetFilter;
                const matchesDistance = distanceFilter === 'all' || sDistance === distanceFilter;
                const matchesLocation = locationFilter === 'all' || sLocation === locationFilter;
                const matchesMonth = monthFilter === 'all' || (sessionDate && String(sMonth) === monthFilter);
                const matchesYear = yearFilter === 'all' || (sessionDate && String(sYear) === yearFilter);
                
                const matchesTurns = turnsFilter === 'all' || 
                                     (turnsFilter === 'single' && !hasTwoTurns) || 
                                     (turnsFilter === 'double' && hasTwoTurns);
                
                const isNotTrainingWithoutScore = !session.trainingWithoutScore;
                
                return matchesType && matchesTarget && matchesDistance && matchesLocation && matchesMonth && matchesYear && matchesTurns && isNotTrainingWithoutScore;
            });

            filteredData.sort((a, b) => new Date(a.data) - new Date(b.data));

            const labels = filteredData.map(s => {
                const formattedDate = formatDate(s.data);
                const sessionType = s.type === 'Gara' ? ' (G)' : ' (A)';
                return `${formattedDate}${sessionType}`;
            });
            
            const dataPoints = filteredData.map(s => s.totalScore); 

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Punteggio Totale Sessione',
                    data: dataPoints,
                    backgroundColor: 'rgba(253, 185, 39, 0.5)', 
                    borderColor: 'rgb(253, 185, 39)',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgb(253, 185, 39)'
                }]
            };

            if (chartInstance) {
                chartInstance.destroy();
            }
            
            if (dataPoints.length === 0) {
                context.clearRect(0, 0, context.canvas.width, context.canvas.height);
                context.font = '20px Inter, sans-serif';
                context.fillStyle = '#fdb927';
                context.textAlign = 'center';
                context.fillText('Nessun dato trovato per i filtri selezionati.', context.canvas.width / 2, context.canvas.height / 2);
                return;
            }

            chartInstance = new Chart(context, {
                type: 'line', 
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Punteggio Totale',
                                color: '#fdb927'
                            },
                            grid: {
                                color: 'rgba(74, 74, 74, 0.5)'
                            },
                            ticks: {
                                color: '#fdb927'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(74, 74, 74, 0.5)'
                            },
                            ticks: {
                                color: '#fdb927',
                                autoSkip: true, 
                                maxRotation: 45,
                                minRotation: 45 
                            },
                            title: {
                                display: true,
                                text: 'Sessioni (in ordine cronologico)',
                                color: '#fdb927'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fdb927'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `Sessione: ${tooltipItems[0].label}`;
                                },
                                label: function(context) {
                                    return `Punteggio: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        // FINE PARTE4D
 // PARTE4E - Obiettivi e Traguardi
        async function loadGoals() {
            try {
                const goalsRef = window.getGoalsCollectionRef();
                if (!goalsRef) return;

                const querySnapshot = await getDocs(goalsRef);
                appState.userGoals = [];
                
                querySnapshot.forEach((doc) => {
                    appState.userGoals.push({ docId: doc.id, ...doc.data() });
                });

                appState.userGoals.sort((a, b) => {
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    return new Date(b.createdAt?.toDate?.() || 0) - new Date(a.createdAt?.toDate?.() || 0);
                });

                console.log('Caricati', appState.userGoals.length, 'obiettivi');
            } catch (error) {
                console.error("Errore caricamento obiettivi:", error);
            }
        }

        function renderGoals() {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            loadGoals().then(() => {
                const activeGoals = appState.userGoals.filter(g => !g.completed);
                const completedGoals = appState.userGoals.filter(g => g.completed);

                const html = `
                    <h2 class="text-3xl font-bold mb-6 text-white">üèÖ I Miei Obiettivi</h2>

                    <button class="btn-primary w-full p-3 rounded-lg mb-6" onclick="window.showAddGoalModal()">
                        ‚ûï Nuovo Obiettivo
                    </button>

                    ${activeGoals.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4 text-primary-orange">üéØ Obiettivi Attivi</h3>
                            <div class="space-y-4">
                                ${activeGoals.map(goal => renderGoalCard(goal)).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6 text-center">
                            <p class="text-white">Nessun obiettivo attivo. Creane uno per iniziare!</p>
                        </div>
                    `}

                    ${completedGoals.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4 text-green-400">‚úÖ Obiettivi Completati</h3>
                            <div class="space-y-4">
                                ${completedGoals.map(goal => renderGoalCard(goal)).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                        Torna al Menu
                    </button>
                `;

                document.getElementById('content-view').innerHTML = html;
            });
        }

        function renderGoalCard(goal) {
            const progress = calculateGoalProgress(goal);
            const isCompleted = goal.completed;
            const progressPercentage = Math.min(100, (progress.current / progress.target) * 100);

            return `
                <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border-2 ${isCompleted ? 'border-green-500' : 'border-primary-orange'}">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold ${isCompleted ? 'text-green-400 line-through' : 'text-white'}">${goal.title}</h4>
                            <p class="text-sm text-primary-orange mt-1">${goal.description}</p>
                        </div>
                        ${!isCompleted ? `
                            <button class="text-red-500 hover:text-red-700 ml-2" onclick="window.deleteGoal('${goal.docId}')">
                                üóëÔ∏è
                            </button>
                        ` : ''}
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                        <div class="bg-gray-800 p-2 rounded">
                            <span class="text-primary-orange">Tipo:</span> ${goal.type === 'score' ? 'üéØ Punteggio' : goal.type === 'sessions' ? 'üìÖ Sessioni' : 'üéì Allenamenti'}
                        </div>
                        <div class="bg-gray-800 p-2 rounded">
                            <span class="text-primary-orange">Periodo:</span> ${goal.period === 'weekly' ? 'Settimanale' : 'Mensile'}
                        </div>
                    </div>

                    ${goal.type === 'score' ? `
                        <div class="text-sm mb-2">
                            <span class="text-primary-orange">Condizioni:</span> ${goal.distanza} | ${goal.tipoTarga}
                        </div>
                    ` : ''}

                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-white">Progresso</span>
                            <span class="font-bold ${isCompleted ? 'text-green-400' : 'text-primary-orange'}">
                                ${progress.current} / ${progress.target} ${goal.type === 'score' ? 'punti' : goal.type === 'sessions' ? 'sessioni' : 'allenamenti'}
                            </span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${isCompleted ? 'bg-green-500' : ''}" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="text-xs text-center mt-1 text-primary-orange">${progressPercentage.toFixed(0)}%</div>
                    </div>

                    ${!isCompleted && progressPercentage >= 100 ? `
                        <button class="btn-primary w-full p-2 rounded-lg mt-3 bg-green-600 hover:bg-green-700 text-white" onclick="window.completeGoal('${goal.docId}')">
                            ‚úÖ Segna come Completato
                        </button>
                    ` : ''}

                    ${isCompleted && goal.completedAt ? `
                        <div class="text-xs text-center text-green-400 mt-2">
                            Completato il ${formatDate(goal.completedAt)}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function calculateGoalProgress(goal) {
            const now = new Date();
            let startDate, endDate;

            if (goal.period === 'weekly') {
                const dayOfWeek = now.getDay();
                const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                startDate = new Date(now.setDate(diff));
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDate.setHours(23, 59, 59, 999);
            } else {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
            }

            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];

            const relevantSessions = appState.sessionData.filter(session => {
                if (session.data < startDateStr || session.data > endDateStr) return false;
                if (session.trainingWithoutScore) {
                    return goal.type === 'training';
                }
                if (goal.type === 'sessions') return true;
                if (goal.type === 'training') return session.type === 'Allenamento';
                if (goal.type === 'score') {
                    return session.distanza === goal.distanza && 
                           session.tipoTarga === goal.tipoTarga;
                }
                return false;
            });

            let current = 0;
            if (goal.type === 'score') {
                const bestSession = relevantSessions.reduce((max, s) => 
                    (s.totalScore || 0) > max ? (s.totalScore || 0) : max, 0);
                current = bestSession;
            } else {
                current = relevantSessions.length;
            }

            return {
                current: current,
                target: goal.targetValue
            };
        }

        window.showAddGoalModal = () => {
            const modalContent = document.createElement('div');
            modalContent.innerHTML = `
                <form id="addGoalForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 text-white">Titolo Obiettivo</label>
                        <input type="text" id="goal-title" class="input-style" required placeholder="Es: Raggiungere 540/600">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 text-white">Descrizione</label>
                        <textarea id="goal-description" class="input-style h-20" placeholder="Descrizione dettagliata (opzionale)"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 text-white">Tipo Obiettivo</label>
                        <select id="goal-type" class="input-style" required onchange="window.toggleGoalFields()">
                            <option value="">Seleziona tipo</option>
                            <option value="score">üéØ Punteggio Target</option>
                            <option value="sessions">üìÖ Numero Sessioni</option>
                            <option value="training">üéì Numero Allenamenti</option>
                        </select>
                    </div>

                    <div id="score-fields" style="display: none;">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-white">Distanza</label>
                                <select id="goal-distanza" class="input-style">
                                    <option value="">Seleziona</option>
                                    ${DISTANZA_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1 text-white">Tipo Targa</label>
                                <select id="goal-targa" class="input-style">
                                    <option value="">Seleziona</option>
                                    ${TIPO_TARGA_OPTIONS.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 text-white">Valore Target</label>
                        <input type="number" id="goal-target" class="input-style" required min="1" placeholder="Es: 540">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 text-white">Periodo</label>
                        <select id="goal-period" class="input-style" required>
                            <option value="">Seleziona periodo</option>
                            <option value="weekly">üìÖ Settimanale</option>
                            <option value="monthly">üìÜ Mensile</option>
                        </select>
                    </div>
                </form>
            `;

            showModal(
                "Nuovo Obiettivo",
                modalContent,
                [
                    { text: "Annulla", handler: () => {} },
                    { text: "Crea", handler: () => saveNewGoal() }
                ]
            );
        };

        window.toggleGoalFields = () => {
            const type = document.getElementById('goal-type').value;
            const scoreFields = document.getElementById('score-fields');
            
            if (type === 'score') {
                scoreFields.style.display = 'block';
                document.getElementById('goal-distanza').required = true;
                document.getElementById('goal-targa').required = true;
            } else {
                scoreFields.style.display = 'none';
                document.getElementById('goal-distanza').required = false;
                document.getElementById('goal-targa').required = false;
            }
        };

        async function saveNewGoal() {
            const title = document.getElementById('goal-title').value.trim();
            const description = document.getElementById('goal-description').value.trim();
            const type = document.getElementById('goal-type').value;
            const targetValue = parseInt(document.getElementById('goal-target').value);
            const period = document.getElementById('goal-period').value;

            if (!title || !type || !targetValue || !period) {
                showModal("Errore", "Compila tutti i campi obbligatori.", [
                    { text: "Ok", handler: () => window.showAddGoalModal() }
                ]);
                return;
            }

            const newGoal = {
                title: title,
                description: description,
                type: type,
                targetValue: targetValue,
                period: period,
                completed: false,
                createdAt: serverTimestamp()
            };

            if (type === 'score') {
                const distanza = document.getElementById('goal-distanza').value;
                const targa = document.getElementById('goal-targa').value;

                if (!distanza || !targa) {
                    showModal("Errore", "Seleziona distanza e tipo targa per l'obiettivo di punteggio.", [
                        { text: "Ok", handler: () => window.showAddGoalModal() }
                    ]);
                    return;
                }

                newGoal.distanza = distanza;
                newGoal.tipoTarga = targa;
            }

            try {
                const goalsRef = window.getGoalsCollectionRef();
                await addDoc(goalsRef, newGoal);
                
                showModal("Successo", "Obiettivo creato con successo!", [
                    { text: "Ok", handler: () => window.setView('goals') }
                ]);
            } catch (error) {
                console.error("Errore creazione obiettivo:", error);
                showModal("Errore", "Impossibile creare l'obiettivo.", [
                    { text: "Ok", handler: () => {} }
                ]);
            }
        }

        window.completeGoal = async (goalId) => {
            try {
                const archerId = appState.loggedInArcher.id;
                const goalDocRef = doc(db, "artifacts", appId, "archers", archerId, "goals", goalId);
                
                const today = new Date().toISOString().split('T')[0];
                
                await updateDoc(goalDocRef, {
                    completed: true,
                    completedAt: today
                });

                showModal("üéâ Congratulazioni!", "Obiettivo completato! Ottimo lavoro!", [
                    { text: "Grazie!", handler: () => window.setView('goals') }
                ]);
            } catch (error) {
                console.error("Errore completamento obiettivo:", error);
                showModal("Errore", "Impossibile completare l'obiettivo.", [
                    { text: "Ok", handler: () => {} }
                ]);
            }
        };

        window.deleteGoal = async (goalId) => {
            showModal(
                "Conferma Eliminazione",
                "Sei sicuro di voler eliminare questo obiettivo?",
                [
                    { text: "Annulla", handler: () => {} },
                    { text: "Elimina", handler: async () => {
                        try {
                            const archerId = appState.loggedInArcher.id;
                            const goalDocRef = doc(db, "artifacts", appId, "archers", archerId, "goals", goalId);
                            await deleteDoc(goalDocRef);
                            
                            window.setView('goals');
                        } catch (error) {
                            console.error("Errore eliminazione obiettivo:", error);
                            showModal("Errore", "Impossibile eliminare l'obiettivo.", [
                                { text: "Ok", handler: () => {} }
                            ]);
                        }
                    }}
                ]
            );
        };
        // FINE PARTE4E
// PARTE4F - Confronto Sessioni
        function renderCompareSessionsView() {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            fetchSessions();

            const html = `
                <h2 class="text-3xl font-bold mb-6 text-white">‚öñÔ∏è Confronta Sessioni</h2>
                <p class="text-sm mb-6 text-primary-orange">Seleziona 2 o 3 sessioni da confrontare (esclusi allenamenti tecnici)</p>

                <div id="sessions-selection-area" class="mb-6">
                    ${renderSessionsSelectionList()}
                </div>

                <div id="selected-sessions-preview" class="mb-6">
                    ${renderSelectedSessionsPreview()}
                </div>

                <div class="flex gap-3">
                    <button class="btn-primary flex-1 p-3 rounded-lg" onclick="window.compareSelectedSessions()" id="compare-btn" disabled>
                        üìä Confronta Sessioni
                    </button>
                    <button class="btn-primary flex-1 p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                        Torna al Menu
                    </button>
                </div>

                <div id="comparison-results" class="mt-6"></div>
            `;

            document.getElementById('content-view').innerHTML = html;
        }

        function renderSessionsSelectionList() {
            const validSessions = appState.sessionData.filter(s => !s.trainingWithoutScore);

            if (validSessions.length < 2) {
                return `
                    <div class="bg-secondary-dark p-6 rounded-xl shadow-lg text-center">
                        <p class="text-white">Hai bisogno di almeno 2 sessioni con punteggio per usare questa funzionalit√†.</p>
                        <p class="text-sm text-primary-orange mt-2">Registra altre sessioni per iniziare!</p>
                    </div>
                `;
            }

            return `
                <div class="bg-secondary-dark p-4 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-white">Seleziona Sessioni (max 3)</h3>
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        ${validSessions.map(session => `
                            <div class="bg-gray-800 p-3 rounded-lg flex items-center hover:bg-gray-700 cursor-pointer transition-all border-2 border-transparent hover:border-primary-orange"
                                 onclick="window.toggleSessionSelection('${session.id}')"
                                 id="session-select-${session.id}">
                                <input type="checkbox" 
                                       class="w-5 h-5 mr-3" 
                                       id="checkbox-${session.id}"
                                       onclick="event.stopPropagation(); window.toggleSessionSelection('${session.id}')">
                                <div class="flex-1">
                                    <div class="font-bold text-white">
                                        ${formatDate(session.data)} - ${session.type}${session.quickScore ? ' ‚ö°' : ''}
                                    </div>
                                    <div class="text-sm text-primary-orange">
                                        ${session.distanza} | ${session.tipoTarga} | Tot: ${session.totalScore}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSelectedSessionsPreview() {
            if (!window.selectedSessionsForComparison || window.selectedSessionsForComparison.length === 0) {
                return '';
            }

            const selectedSessions = window.selectedSessionsForComparison.map(id => 
                appState.sessionData.find(s => String(s.id) === String(id))
            ).filter(s => s);

            return `
                <div class="bg-secondary-dark p-4 rounded-xl shadow-lg border-2 border-primary-orange">
                    <h3 class="text-xl font-bold mb-3 text-white">Sessioni Selezionate (${selectedSessions.length}/3)</h3>
                    <div class="space-y-2">
                        ${selectedSessions.map(session => `
                            <div class="bg-gray-800 p-2 rounded flex justify-between items-center">
                                <span class="text-white text-sm">${formatDate(session.data)} - ${session.type} (${session.totalScore} punti)</span>
                                <button class="text-red-500 hover:text-red-700" onclick="window.toggleSessionSelection('${session.id}')">‚úñ</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        window.selectedSessionsForComparison = window.selectedSessionsForComparison || [];

        window.toggleSessionSelection = (sessionId) => {
            const index = window.selectedSessionsForComparison.indexOf(sessionId);
            const checkbox = document.getElementById(`checkbox-${sessionId}`);
            const sessionDiv = document.getElementById(`session-select-${sessionId}`);

            if (index > -1) {
                window.selectedSessionsForComparison.splice(index, 1);
                if (checkbox) checkbox.checked = false;
                if (sessionDiv) sessionDiv.classList.remove('border-primary-orange', 'bg-gray-700');
            } else {
                if (window.selectedSessionsForComparison.length >= 3) {
                    showModal("Limite Raggiunto", "Puoi confrontare massimo 3 sessioni alla volta.", [
                        { text: "Ok", handler: () => {} }
                    ]);
                    return;
                }
                window.selectedSessionsForComparison.push(sessionId);
                if (checkbox) checkbox.checked = true;
                if (sessionDiv) sessionDiv.classList.add('border-primary-orange', 'bg-gray-700');
            }

            const previewArea = document.getElementById('selected-sessions-preview');
            if (previewArea) {
                previewArea.innerHTML = renderSelectedSessionsPreview();
            }

            const compareBtn = document.getElementById('compare-btn');
            if (compareBtn) {
                compareBtn.disabled = window.selectedSessionsForComparison.length < 2;
            }
        };

        window.compareSelectedSessions = () => {
            if (window.selectedSessionsForComparison.length < 2) {
                showModal("Errore", "Seleziona almeno 2 sessioni da confrontare.", [
                    { text: "Ok", handler: () => {} }
                ]);
                return;
            }

            const selectedSessions = window.selectedSessionsForComparison.map(id => 
                appState.sessionData.find(s => String(s.id) === String(id))
            ).filter(s => s);

            const resultsArea = document.getElementById('comparison-results');
            if (resultsArea) {
                resultsArea.innerHTML = renderComparisonResults(selectedSessions);
            }
        };

        function renderComparisonResults(sessions) {
            const colors = ['bg-blue-600', 'bg-green-600', 'bg-purple-600'];
            const borderColors = ['border-blue-500', 'border-green-500', 'border-purple-500'];

            const maxScore = Math.max(...sessions.map(s => s.totalScore || 0));
            const maxX = Math.max(...sessions.map(s => s.totalX || 0));
            const maxTen = Math.max(...sessions.map(s => s.totalTen || 0));
            const maxAvg = Math.max(...sessions.map(s => s.totalAverage || 0));

            return `
                <div class="bg-secondary-dark p-6 rounded-xl shadow-lg border-2 border-primary-orange">
                    <h3 class="text-2xl font-bold mb-6 text-white text-center">üìä Risultati Confronto</h3>

                    <!-- Confronto Punteggi Totali -->
                    <div class="mb-6">
                        <h4 class="text-lg font-bold mb-3 text-primary-orange">Punteggi Totali</h4>
                        <div class="space-y-3">
                            ${sessions.map((session, index) => {
                                const percentage = (session.totalScore / maxScore) * 100;
                                return `
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-white">${formatDate(session.data)} ${session.quickScore ? '‚ö°' : ''}</span>
                                            <span class="font-bold ${session.totalScore === maxScore ? 'text-green-400' : 'text-white'}">${session.totalScore}</span>
                                        </div>
                                        <div class="bg-gray-700 rounded-full h-6 overflow-hidden">
                                            <div class="${colors[index]} h-full flex items-center justify-end pr-2 text-white text-xs font-bold" 
                                                 style="width: ${percentage}%">
                                                ${percentage.toFixed(0)}%
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Tabella Comparativa Dettagliata -->
                    <div class="mb-6 overflow-x-auto">
                        <h4 class="text-lg font-bold mb-3 text-primary-orange">Statistiche Dettagliate</h4>
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b-2 border-primary-orange">
                                    <th class="text-left p-2 text-white">Metrica</th>
                                    ${sessions.map((session, index) => `
                                        <th class="p-2 text-center ${borderColors[index]} border-l-2">
                                            ${formatDate(session.data)}
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody class="text-white">
                                <tr class="border-b border-gray-700">
                                    <td class="p-2 font-bold">Tipo</td>
                                    ${sessions.map((s, i) => `
                                        <td class="p-2 text-center ${borderColors[i]} border-l-2">${s.type}</td>
                                    `).join('')}
                                </tr>
                                <tr class="border-b border-gray-700">
                                    <td class="p-2 font-bold">Distanza</td>
                                    ${sessions.map((s, i) => `
                                        <td class="p-2 text-center ${borderColors[i]} border-l-2">${s.distanza}</td>
                                    `).join('')}
                                </tr>
                                <tr class="border-b border-gray-700">
                                    <td class="p-2 font-bold">Targa</td>
                                    ${sessions.map((s, i) => `
                                        <td class="p-2 text-center ${borderColors[i]} border-l-2">${s.tipoTarga}</td>
                                    `).join('')}
                                </tr>
                                <tr class="border-b border-gray-700 bg-gray-800">
                                    <td class="p-2 font-bold">Punteggio Totale</td>
                                    ${sessions.map((s, i) => `
                                        <td class="p-2 text-center ${borderColors[i]} border-l-2 ${s.totalScore === maxScore ? 'text-green-400 font-bold' : ''}">${s.totalScore}</td>
                                    `).join('')}
                                </tr>
                                ${!sessions.some(s => s.quickScore) ? `
                                    <tr class="border-b border-gray-700">
                                        <td class="p-2 font-bold">Media Freccia</td>
                                        ${sessions.map((s, i) => `
                                            <td class="p-2 text-center ${borderColors[i]} border-l-2 ${s.totalAverage === maxAvg ? 'text-green-400 font-bold' : ''}">${s.totalAverage ? s.totalAverage.toFixed(2) : '-'}</td>
                                        `).join('')}
                                    </tr>
                                    <tr class="border-b border-gray-700">
                                        <td class="p-2 font-bold">X</td>
                                        ${sessions.map((s, i) => `
                                            <td class="p-2 text-center ${borderColors[i]} border-l-2 ${s.totalX === maxX ? 'text-green-400 font-bold' : ''}">${s.totalX || 0}</td>
                                        `).join('')}
                                    </tr>
                                    <tr class="border-b border-gray-700">
                                        <td class="p-2 font-bold">10</td>
                                        ${sessions.map((s, i) => `
                                            <td class="p-2 text-center ${borderColors[i]} border-l-2 ${s.totalTen === maxTen ? 'text-green-400 font-bold' : ''}">${s.totalTen || 0}</td>
                                        `).join('')}
                                    </tr>
                                ` : ''}
                                <tr class="border-b border-gray-700">
                                    <td class="p-2 font-bold">Turno 1</td>
                                    ${sessions.map((s, i) => `
                                        <td class="p-2 text-center ${borderColors[i]} border-l-2">${s.turn1Score || 0}</td>
                                    `).join('')}
                                </tr>
                                <tr class="border-b border-gray-700">
                                    <td class="p-2 font-bold">Turno 2</td>
                                    ${sessions.map((s, i) => `
                                        <td class="p-2 text-center ${borderColors[i]} border-l-2">${s.turn2Score || 0}</td>
                                    `).join('')}
                                </tr>
                                <tr class="border-b border-gray-700">
                                    <td class="p-2 font-bold">Durata</td>
                                    ${sessions.map((s, i) => `
                                        <td class="p-2 text-center ${borderColors[i]} border-l-2">${durationToString(s.duration)}</td>
                                    `).join('')}
                                </tr>
                                <tr class="border-b border-gray-700">
                                    <td class="p-2 font-bold">Luogo</td>
                                    ${sessions.map((s, i) => `
                                        <td class="p-2 text-center ${borderColors[i]} border-l-2">${s.luogo}</td>
                                    `).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Differenze e Insights -->
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h4 class="text-lg font-bold mb-3 text-primary-orange">üí° Insights</h4>
                        <div class="space-y-2 text-sm text-white">
                            ${generateInsights(sessions)}
                        </div>
                    </div>

                    <!-- Azioni -->
                    <div class="mt-6 flex gap-3">
                        <button class="btn-primary flex-1 p-3 rounded-lg" onclick="window.resetComparison()">
                            üîÑ Nuovo Confronto
                        </button>
                        <button class="btn-primary flex-1 p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" 
                                onclick="window.viewSessionDetails('${sessions[0].id}')">
                            üëÅÔ∏è Vedi Dettagli
                        </button>
                    </div>
                </div>
            `;
        }

        function generateInsights(sessions) {
            const insights = [];
            
            const bestSession = sessions.reduce((max, s) => (s.totalScore || 0) > (max.totalScore || 0) ? s : max);
            insights.push(`‚úÖ <strong>Miglior punteggio:</strong> ${formatDate(bestSession.data)} con ${bestSession.totalScore} punti`);

            const scores = sessions.map(s => s.totalScore || 0);
            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            const variance = scores.reduce((sum, score) => sum + Math.pow(score - avgScore, 2), 0) / scores.length;
            const stdDev = Math.sqrt(variance);
            
            insights.push(`üìä <strong>Punteggio medio:</strong> ${avgScore.toFixed(2)} punti`);
            insights.push(`üìà <strong>Deviazione standard:</strong> ${stdDev.toFixed(2)} (${stdDev < 10 ? 'Prestazioni molto costanti!' : stdDev < 20 ? 'Buona costanza' : 'Prestazioni variabili'})`);

            const maxDiff = Math.max(...scores) - Math.min(...scores);
            insights.push(`‚öñÔ∏è <strong>Differenza max-min:</strong> ${maxDiff} punti`);

            if (!sessions.some(s => s.quickScore)) {
                const avgArrow = sessions.map(s => s.totalAverage || 0);
                const bestAvg = Math.max(...avgArrow);
                const bestAvgSession = sessions.find(s => s.totalAverage === bestAvg);
                insights.push(`üéØ <strong>Miglior media freccia:</strong> ${formatDate(bestAvgSession.data)} con ${bestAvg.toFixed(2)}`);
            }

            const indoorSessions = sessions.filter(s => s.tipoLuogo === 'Indoor');
            const outdoorSessions = sessions.filter(s => s.tipoLuogo === 'Outdoor');
            
            if (indoorSessions.length > 0 && outdoorSessions.length > 0) {
                const indoorAvg = indoorSessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / indoorSessions.length;
                const outdoorAvg = outdoorSessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / outdoorSessions.length;
                const diff = indoorAvg - outdoorAvg;
                
                if (Math.abs(diff) > 10) {
                    insights.push(`üè† <strong>Indoor vs Outdoor:</strong> ${diff > 0 ? 'Indoor migliore' : 'Outdoor migliore'} di ${Math.abs(diff).toFixed(0)} punti in media`);
                }
            }

            return insights.map(insight => `<div>‚Ä¢ ${insight}</div>`).join('');
        }

        window.resetComparison = () => {
            window.selectedSessionsForComparison = [];
            renderCompareSessionsView();
        };

        window.viewSessionDetails = (sessionId) => {
            window.setView('detailedSummary', { sessionId: sessionId });
        };
        // FINE PARTE4F   
// PARTE4G - Dashboard Statistiche Personalizzate
        function renderDashboard() {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            fetchSessions();

            setTimeout(() => {
                calculateAllStatistics();
                renderDashboardContent();
            }, 300);
        }

        function calculateAllStatistics() {
            const validSessions = appState.sessionData.filter(s => !s.trainingWithoutScore);

            if (validSessions.length === 0) {
                appState.statistics = { hasData: false };
                return;
            }

            // Statistiche Generali
            const totalSessions = validSessions.length;
            const totalScore = validSessions.reduce((sum, s) => sum + (s.totalScore || 0), 0);
            const avgScore = totalScore / totalSessions;

            const allScores = validSessions.map(s => s.totalScore || 0);
            const maxScore = Math.max(...allScores);
            const minScore = Math.min(...allScores);
            const bestSession = validSessions.find(s => s.totalScore === maxScore);

            // Calcolo deviazione standard
            const variance = allScores.reduce((sum, score) => sum + Math.pow(score - avgScore, 2), 0) / totalSessions;
            const stdDev = Math.sqrt(variance);

            // Statistiche per Distanza
            const byDistance = {};
            DISTANZA_OPTIONS.forEach(dist => {
                const sessions = validSessions.filter(s => s.distanza === dist);
                if (sessions.length > 0) {
                    byDistance[dist] = {
                        count: sessions.length,
                        avgScore: sessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / sessions.length,
                        maxScore: Math.max(...sessions.map(s => s.totalScore || 0))
                    };
                }
            });

            // Statistiche per Tipo Targa
            const byTarget = {};
            TIPO_TARGA_OPTIONS.forEach(target => {
                const sessions = validSessions.filter(s => s.tipoTarga === target);
                if (sessions.length > 0) {
                    byTarget[target] = {
                        count: sessions.length,
                        avgScore: sessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / sessions.length,
                        maxScore: Math.max(...sessions.map(s => s.totalScore || 0))
                    };
                }
            });

            // Indoor vs Outdoor
            const indoorSessions = validSessions.filter(s => s.tipoLuogo === 'Indoor');
            const outdoorSessions = validSessions.filter(s => s.tipoLuogo === 'Outdoor');

            const indoorStats = indoorSessions.length > 0 ? {
                count: indoorSessions.length,
                avgScore: indoorSessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / indoorSessions.length,
                maxScore: Math.max(...indoorSessions.map(s => s.totalScore || 0))
            } : null;

            const outdoorStats = outdoorSessions.length > 0 ? {
                count: outdoorSessions.length,
                avgScore: outdoorSessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / outdoorSessions.length,
                maxScore: Math.max(...outdoorSessions.map(s => s.totalScore || 0))
            } : null;

            // Percentuali X, 10, 9
            const sessionsWithDetails = validSessions.filter(s => !s.quickScore);
            const totalArrows = sessionsWithDetails.reduce((sum, s) => {
                const format = s.formatoGara;
                if (format.includes('3x10')) return sum + 30;
                if (format.includes('6x6')) return sum + 36;
                if (format.includes('6x12')) return sum + 72;
                return sum;
            }, 0);

            const totalX = sessionsWithDetails.reduce((sum, s) => sum + (s.totalX || 0), 0);
            const totalTen = sessionsWithDetails.reduce((sum, s) => sum + (s.totalTen || 0), 0);
            const totalNine = sessionsWithDetails.reduce((sum, s) => sum + (s.totalNine || 0), 0);

            const percentX = totalArrows > 0 ? (totalX / totalArrows * 100) : 0;
            const percentTen = totalArrows > 0 ? (totalTen / totalArrows * 100) : 0;
            const percentNine = totalArrows > 0 ? (totalNine / totalArrows * 100) : 0;

            // Analisi Fasce Orarie
            const timeSlots = {
                morning: { name: 'Mattino (6-12)', sessions: [], scores: [] },
                afternoon: { name: 'Pomeriggio (12-18)', sessions: [], scores: [] },
                evening: { name: 'Sera (18-24)', sessions: [], scores: [] },
                night: { name: 'Notte (0-6)', sessions: [], scores: [] }
            };

            validSessions.forEach(s => {
                if (!s.startTime) return;
                const hour = parseInt(s.startTime.split(':')[0]);
                
                if (hour >= 6 && hour < 12) {
                    timeSlots.morning.sessions.push(s);
                    timeSlots.morning.scores.push(s.totalScore || 0);
                } else if (hour >= 12 && hour < 18) {
                    timeSlots.afternoon.sessions.push(s);
                    timeSlots.afternoon.scores.push(s.totalScore || 0);
                } else if (hour >= 18 && hour < 24) {
                    timeSlots.evening.sessions.push(s);
                    timeSlots.evening.scores.push(s.totalScore || 0);
                } else {
                    timeSlots.night.sessions.push(s);
                    timeSlots.night.scores.push(s.totalScore || 0);
                }
            });

            Object.keys(timeSlots).forEach(slot => {
                const data = timeSlots[slot];
                if (data.scores.length > 0) {
                    data.avgScore = data.scores.reduce((a, b) => a + b, 0) / data.scores.length;
                    data.count = data.sessions.length;
                } else {
                    data.avgScore = 0;
                    data.count = 0;
                }
            });

            // Trend Miglioramento (ultime 10 sessioni vs prime 10)
            let trend = null;
            if (validSessions.length >= 10) {
                const first10 = validSessions.slice(0, 10);
                const last10 = validSessions.slice(-10);
                
                const avgFirst = first10.reduce((sum, s) => sum + (s.totalScore || 0), 0) / 10;
                const avgLast = last10.reduce((sum, s) => sum + (s.totalScore || 0), 0) / 10;
                
                trend = {
                    improvement: avgLast - avgFirst,
                    percentChange: ((avgLast - avgFirst) / avgFirst * 100)
                };
            }

            // Correlazione Durata-Prestazione
            const sessionsWithDuration = validSessions.filter(s => s.duration && s.duration > 0);
            let durationCorrelation = null;
            
            if (sessionsWithDuration.length >= 5) {
                const shortSessions = sessionsWithDuration.filter(s => s.duration <= 60);
                const mediumSessions = sessionsWithDuration.filter(s => s.duration > 60 && s.duration <= 120);
                const longSessions = sessionsWithDuration.filter(s => s.duration > 120);

                durationCorrelation = {
                    short: shortSessions.length > 0 ? {
                        count: shortSessions.length,
                        avg: shortSessions.reduce((sum, s) => sum + s.totalScore, 0) / shortSessions.length
                    } : null,
                    medium: mediumSessions.length > 0 ? {
                        count: mediumSessions.length,
                        avg: mediumSessions.reduce((sum, s) => sum + s.totalScore, 0) / mediumSessions.length
                    } : null,
                    long: longSessions.length > 0 ? {
                        count: longSessions.length,
                        avg: longSessions.reduce((sum, s) => sum + s.totalScore, 0) / longSessions.length
                    } : null
                };
            }

            appState.statistics = {
                hasData: true,
                general: {
                    totalSessions,
                    avgScore,
                    maxScore,
                    minScore,
                    stdDev,
                    bestSession
                },
                byDistance,
                byTarget,
                indoor: indoorStats,
                outdoor: outdoorStats,
                accuracy: {
                    percentX,
                    percentTen,
                    percentNine,
                    totalX,
                    totalTen,
                    totalNine
                },
                timeSlots,
                trend,
                durationCorrelation
            };
        }

        function renderDashboardContent() {
            const stats = appState.statistics;

            if (!stats || !stats.hasData) {
                document.getElementById('content-view').innerHTML = `
                    <h2 class="text-3xl font-bold mb-6 text-white">üéØ Dashboard Statistiche</h2>
                    <div class="bg-secondary-dark p-6 rounded-xl shadow-lg text-center">
                        <p class="text-white text-lg">Non ci sono abbastanza dati per generare statistiche.</p>
                        <p class="text-sm text-primary-orange mt-2">Registra almeno una sessione con punteggio per iniziare!</p>
                    </div>
                    <button class="btn-primary w-full p-3 rounded-lg mt-6" onclick="window.setView('mainMenu')">
                        Torna al Menu
                    </button>
                `;
                return;
            }

            const html = `
                <h2 class="text-3xl font-bold mb-6 text-white">üéØ Dashboard Statistiche</h2>

                <!-- Statistiche Generali -->
                <div class="stats-card mb-6">
                    <h3 class="text-2xl font-bold mb-4 text-white">üìä Panoramica Generale</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-xs text-primary-orange mb-1">Sessioni Totali</div>
                            <div class="text-3xl font-bold text-white">${stats.general.totalSessions}</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-xs text-primary-orange mb-1">Media Punteggio</div>
                            <div class="text-3xl font-bold text-white">${stats.general.avgScore.toFixed(1)}</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-xs text-primary-orange mb-1">Record Personale</div>
                            <div class="text-3xl font-bold text-green-400">${stats.general.maxScore}</div>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center">
                            <div class="text-xs text-primary-orange mb-1">Consistenza</div>
                            <div class="text-xl font-bold ${stats.general.stdDev < 15 ? 'text-green-400' : stats.general.stdDev < 25 ? 'text-yellow-400' : 'text-red-400'}">
                                ¬±${stats.general.stdDev.toFixed(1)}
                            </div>
                        </div>
                    </div>
                    ${stats.general.bestSession ? `
                        <div class="bg-green-900 bg-opacity-30 p-3 rounded-lg mt-4 border border-green-500">
                            <p class="text-sm text-green-400">
                                üèÜ <strong>Miglior prestazione:</strong> ${stats.general.maxScore} punti 
                                il ${formatDate(stats.general.bestSession.data)} 
                                (${stats.general.bestSession.distanza} - ${stats.general.bestSession.tipoTarga})
                            </p>
                        </div>
                    ` : ''}
                </div>

                <!-- Accuratezza -->
                ${stats.accuracy.totalX > 0 || stats.accuracy.totalTen > 0 ? `
                    <div class="stats-card mb-6">
                        <h3 class="text-2xl font-bold mb-4 text-white">üéØ Accuratezza</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-center mb-2">
                                    <div class="text-4xl font-bold text-yellow-400">${stats.accuracy.percentX.toFixed(1)}%</div>
                                    <div class="text-xs text-primary-orange">X</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-yellow-400" style="width: ${stats.accuracy.percentX}%"></div>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-center mb-2">
                                    <div class="text-4xl font-bold text-green-400">${stats.accuracy.percentTen.toFixed(1)}%</div>
                                    <div class="text-xs text-primary-orange">10</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-green-400" style="width: ${stats.accuracy.percentTen}%"></div>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <div class="text-center mb-2">
                                    <div class="text-4xl font-bold text-blue-400">${stats.accuracy.percentNine.toFixed(1)}%</div>
                                    <div class="text-xs text-primary-orange">9</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-blue-400" style="width: ${stats.accuracy.percentNine}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-center text-gray-400 mt-2">
                            Totali: X=${stats.accuracy.totalX}, 10=${stats.accuracy.totalTen}, 9=${stats.accuracy.totalNine}
                        </div>
                    </div>
                ` : ''}

                <!-- Prestazioni per Distanza -->
                ${Object.keys(stats.byDistance).length > 0 ? `
                    <div class="stats-card mb-6">
                        <h3 class="text-2xl font-bold mb-4 text-white">üìè Prestazioni per Distanza</h3>
                        <div class="space-y-3">
                            ${Object.entries(stats.byDistance).map(([dist, data]) => {
                                const maxPossible = 360; // Assumiamo max 360
                                const percentage = (data.avgScore / maxPossible) * 100;
                                return `
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-white font-bold">${dist}</span>
                                            <span class="text-primary-orange">${data.avgScore.toFixed(1)} media | ${data.maxScore} max | ${data.count} sessioni</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Prestazioni per Tipo Targa -->
                ${Object.keys(stats.byTarget).length > 0 ? `
                    <div class="stats-card mb-6">
                        <h3 class="text-2xl font-bold mb-4 text-white">üéØ Prestazioni per Tipo Targa</h3>
                        <div class="space-y-3">
                            ${Object.entries(stats.byTarget).map(([target, data]) => {
                                const maxPossible = 360;
                                const percentage = (data.avgScore / maxPossible) * 100;
                                return `
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-white font-bold">${target}</span>
                                            <span class="text-primary-orange">${data.avgScore.toFixed(1)} media | ${data.maxScore} max | ${data.count} sessioni</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Indoor vs Outdoor -->
                ${stats.indoor && stats.outdoor ? `
                    <div class="stats-card mb-6">
                        <h3 class="text-2xl font-bold mb-4 text-white">üè† Indoor vs üå≥ Outdoor</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-900 bg-opacity-30 p-4 rounded-lg border border-blue-500">
                                <h4 class="text-lg font-bold text-blue-400 mb-2">üè† Indoor</h4>
                                <div class="text-3xl font-bold text-white mb-1">${stats.indoor.avgScore.toFixed(1)}</div>
                                <div class="text-xs text-blue-300">Media | Max: ${stats.indoor.maxScore} | ${stats.indoor.count} sessioni</div>
                            </div>
                            <div class="bg-green-900 bg-opacity-30 p-4 rounded-lg border border-green-500">
                                <h4 class="text-lg font-bold text-green-400 mb-2">üå≥ Outdoor</h4>
                                <div class="text-3xl font-bold text-white mb-1">${stats.outdoor.avgScore.toFixed(1)}</div>
                                <div class="text-xs text-green-300">Media | Max: ${stats.outdoor.maxScore} | ${stats.outdoor.count} sessioni</div>
                            </div>
                        </div>
                        ${Math.abs(stats.indoor.avgScore - stats.outdoor.avgScore) > 10 ? `
                            <div class="mt-3 p-2 bg-gray-800 rounded text-sm text-center">
                                <span class="text-primary-orange">
                                    üí° Performa meglio ${stats.indoor.avgScore > stats.outdoor.avgScore ? 'Indoor' : 'Outdoor'} 
                                    di ${Math.abs(stats.indoor.avgScore - stats.outdoor.avgScore).toFixed(1)} punti in media
                                </span>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}

                <!-- Analisi Fasce Orarie -->
                <div class="stats-card mb-6">
                    <h3 class="text-2xl font-bold mb-4 text-white">üïê Prestazioni per Fascia Oraria</h3>
                    <div class="space-y-3">
                        ${Object.entries(stats.timeSlots)
                            .filter(([_, data]) => data.count > 0)
                            .sort((a, b) => b[1].avgScore - a[1].avgScore)
                            .map(([slot, data], index) => {
                                const maxAvg = Math.max(...Object.values(stats.timeSlots).map(s => s.avgScore));
                                const percentage = (data.avgScore / maxAvg) * 100;
                                return `
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-white font-bold">${index === 0 ? '‚≠ê ' : ''}${data.name}</span>
                                            <span class="text-primary-orange">${data.avgScore.toFixed(1)} media | ${data.count} sessioni</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill ${index === 0 ? 'bg-green-500' : ''}" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                    </div>
                    ${(() => {
                        const bestSlot = Object.entries(stats.timeSlots)
                            .filter(([_, data]) => data.count > 0)
                            .sort((a, b) => b[1].avgScore - a[1].avgScore)[0];
                        return bestSlot ? `
                            <div class="mt-3 p-2 bg-green-900 bg-opacity-30 rounded text-sm text-center border border-green-500">
                                <span class="text-green-400">
                                    üí° Tendi a tirare meglio ${bestSlot[1].name.toLowerCase()}
                                </span>
                            </div>
                        ` : '';
                    })()}
                </div>

                <!-- Trend Miglioramento -->
                ${stats.trend ? `
                    <div class="stats-card mb-6">
                        <h3 class="text-2xl font-bold mb-4 text-white">üìà Trend di Miglioramento</h3>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="text-center">
                                <div class="text-sm text-primary-orange mb-2">Prime 10 sessioni vs Ultime 10 sessioni</div>
                                <div class="text-5xl font-bold ${stats.trend.improvement >= 0 ? 'text-green-400' : 'text-red-400'} mb-2">
                                    ${stats.trend.improvement >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.trend.improvement).toFixed(1)}
                                </div>
                                <div class="text-xl ${stats.trend.improvement >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    ${stats.trend.improvement >= 0 ? '+' : ''}${stats.trend.percentChange.toFixed(1)}%
                                </div>
                                <div class="text-xs text-gray-400 mt-2">
                                    ${stats.trend.improvement >= 0 ? 'üéâ Stai migliorando!' : '‚ö†Ô∏è Necessario pi√π allenamento'}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Correlazione Durata-Prestazione -->
                ${stats.durationCorrelation ? `
                    <div class="stats-card mb-6">
                        <h3 class="text-2xl font-bold mb-4 text-white">‚è±Ô∏è Durata Sessione vs Prestazione</h3>
                        <div class="grid grid-cols-3 gap-3">
                            ${stats.durationCorrelation.short ? `
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-xs text-primary-orange mb-1">‚â§ 1 ora</div>
                                    <div class="text-2xl font-bold text-white">${stats.durationCorrelation.short.avg.toFixed(1)}</div>
                                    <div class="text-xs text-gray-400">${stats.durationCorrelation.short.count} sessioni</div>
                                </div>
                            ` : ''}
                            ${stats.durationCorrelation.medium ? `
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-xs text-primary-orange mb-1">1-2 ore</div>
                                    <div class="text-2xl font-bold text-white">${stats.durationCorrelation.medium.avg.toFixed(1)}</div>
                                    <div class="text-xs text-gray-400">${stats.durationCorrelation.medium.count} sessioni</div>
                                </div>
                            ` : ''}
                            ${stats.durationCorrelation.long ? `
                                <div class="bg-gray-800 p-3 rounded-lg text-center">
                                    <div class="text-xs text-primary-orange mb-1">> 2 ore</div>
                                    <div class="text-2xl font-bold text-white">${stats.durationCorrelation.long.avg.toFixed(1)}</div>
                                    <div class="text-xs text-gray-400">${stats.durationCorrelation.long.count} sessioni</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}

                <button class="btn-primary w-full p-3 rounded-lg" onclick="window.setView('mainMenu')">
                    Torna al Menu
                </button>
            `;

            document.getElementById('content-view').innerHTML = html;
        }
        // FINE PARTE4G
// PARTE4H - Grafici Multipli
        function renderMultipleCharts() {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            fetchSessions();

            setTimeout(() => {
                const html = `
                    <h2 class="text-3xl font-bold mb-6 text-white">üìä Grafici Multipli</h2>

                    <!-- Grafico a Torta - Distribuzione Punteggi -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">ü•ß Distribuzione Punteggi (X/10/9/8...)</h3>
                        <div style="height: 300px;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>

                    <!-- Grafico a Barre - Confronto Distanze ALLENAMENTI -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üèãÔ∏è Media Punteggi per Distanza - ALLENAMENTI</h3>
                        <div class="mb-3">
                            <label class="inline-flex items-center mr-4">
                                <input type="radio" name="training-turns-distance" value="all" checked onchange="drawBarChartDistanceTraining()">
                                <span class="ml-2 text-white text-sm">Tutti</span>
                            </label>
                            <label class="inline-flex items-center mr-4">
                                <input type="radio" name="training-turns-distance" value="1" onchange="drawBarChartDistanceTraining()">
                                <span class="ml-2 text-white text-sm">Solo 1 Turno</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="training-turns-distance" value="2" onchange="drawBarChartDistanceTraining()">
                                <span class="ml-2 text-white text-sm">Solo 2 Turni</span>
                            </label>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="barChartDistanceTraining"></canvas>
                        </div>
                    </div>

                    <!-- Grafico a Barre - Confronto Distanze GARE -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üèÜ Media Punteggi per Distanza - GARE</h3>
                        <div style="height: 300px;">
                            <canvas id="barChartDistanceRace"></canvas>
                        </div>
                    </div>

                    <!-- Grafico a Barre - Confronto Targhe ALLENAMENTI -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üèãÔ∏è Media Punteggi per Tipo Targa - ALLENAMENTI</h3>
                        <div class="mb-3">
                            <label class="inline-flex items-center mr-4">
                                <input type="radio" name="training-turns-target" value="all" checked onchange="drawBarChartTargetTraining()">
                                <span class="ml-2 text-white text-sm">Tutti</span>
                            </label>
                            <label class="inline-flex items-center mr-4">
                                <input type="radio" name="training-turns-target" value="1" onchange="drawBarChartTargetTraining()">
                                <span class="ml-2 text-white text-sm">Solo 1 Turno</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="training-turns-target" value="2" onchange="drawBarChartTargetTraining()">
                                <span class="ml-2 text-white text-sm">Solo 2 Turni</span>
                            </label>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="barChartTargetTraining"></canvas>
                        </div>
                    </div>

                    <!-- Grafico a Barre - Confronto Targhe GARE -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üèÜ Media Punteggi per Tipo Targa - GARE</h3>
                        <div style="height: 300px;">
                            <canvas id="barChartTargetRace"></canvas>
                        </div>
                    </div>

                    <!-- Heatmap Giorni -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üóìÔ∏è Heatmap Prestazioni: Giorni della Settimana</h3>
                        <div id="heatmapDays"></div>
                    </div>

                    <!-- Heatmap Orari -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üïê Heatmap Prestazioni: Fasce Orarie</h3>
                        <div id="heatmapHours"></div>
                    </div>

                    <!-- Grafico Consistenza -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üìâ Consistenza (Deviazione Standard)</h3>
                        <p class="text-sm text-gray-400 mb-3">
                            La deviazione standard misura quanto variano i tuoi punteggi: 
                            üü¢ < 15 (molto costante) | üü° 15-25 (buono) | üî¥ > 25 (variabile)
                        </p>
                        <div style="height: 300px;">
                            <canvas id="consistencyChart"></canvas>
                        </div>
                    </div>

                    <button class="btn-primary w-full p-3 rounded-lg" onclick="window.setView('mainMenu')">
                        Torna al Menu
                    </button>
                `;

                document.getElementById('content-view').innerHTML = html;

                drawPieChart();
                drawBarChartDistanceTraining();
                drawBarChartDistanceRace();
                drawBarChartTargetTraining();
                drawBarChartTargetRace();
                drawHeatmapDays();
                drawHeatmapHours();
                drawConsistencyChart();
            }, 300);
        }

        function drawPieChart() {
            const validSessions = appState.sessionData.filter(s => !s.trainingWithoutScore && !s.quickScore);
            
            if (validSessions.length === 0) {
                document.getElementById('pieChart').parentElement.innerHTML = '<p class="text-center text-white">Nessun dato disponibile (esclusi Quick Score)</p>';
                return;
            }

            // Conta tutte le frecce per punteggio
            const scoreCounts = { X: 0, '10': 0, '9': 0, '8': 0, '7': 0, '6': 0, '5': 0, '4': 0, '3': 0, '2': 0, '1': 0, 'M': 0 };

            validSessions.forEach(session => {
                [session.turn1, session.turn2].forEach(turn => {
                    if (!turn || !turn.grid) return;
                    
                    const grid = turn.grid.map(rowStr => JSON.parse(rowStr));
                    grid.forEach(row => {
                        row.forEach(score => {
                            if (score && scoreCounts.hasOwnProperty(score)) {
                                scoreCounts[score]++;
                            } else if (score === '10') {
                                scoreCounts['10']++;
                            }
                        });
                    });
                });
            });

            const labels = Object.keys(scoreCounts).filter(key => scoreCounts[key] > 0);
            const data = labels.map(key => scoreCounts[key]);

            const ctx = document.getElementById('pieChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FFD700', // X - oro
                            '#FDB927', // 10 - arancione
                            '#4CAF50', // 9 - verde
                            '#2196F3', // 8 - blu
                            '#9C27B0', // 7 - viola
                            '#FF9800', // 6 - arancione scuro
                            '#F44336', // 5 - rosso
                            '#795548', // 4 - marrone
                            '#607D8B', // 3 - grigio
                            '#9E9E9E', // 2 - grigio chiaro
                            '#FFFFFF', // 1 - bianco
                            '#000000'  // M - nero
                        ],
                        borderWidth: 2,
                        borderColor: '#1a1a1a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#fdb927',
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} frecce (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Variabile globale per tenere traccia dei chart instances
        window.chartInstances = window.chartInstances || {};

        function drawBarChartDistanceTraining() {
            const turnFilter = document.querySelector('input[name="training-turns-distance"]:checked')?.value || 'all';
            
            let trainingSessions = appState.sessionData.filter(s => 
                !s.trainingWithoutScore && s.type === 'Allenamento'
            );

            // Applica filtro turni
            if (turnFilter === '1') {
                trainingSessions = trainingSessions.filter(s => !s.turn2Score || s.turn2Score === 0);
            } else if (turnFilter === '2') {
                trainingSessions = trainingSessions.filter(s => s.turn2Score && s.turn2Score > 0);
            }

            const byDistance = {};
            DISTANZA_OPTIONS.forEach(dist => {
                const sessions = trainingSessions.filter(s => s.distanza === dist);
                if (sessions.length > 0) {
                    byDistance[dist] = {
                        avg: sessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / sessions.length,
                        count: sessions.length
                    };
                }
            });

            const canvas = document.getElementById('barChartDistanceTraining');
            
            if (Object.keys(byDistance).length === 0) {
                canvas.parentElement.innerHTML = '<p class="text-center text-white">Nessun dato disponibile per il filtro selezionato</p>';
                return;
            }

            const labels = Object.keys(byDistance);
            const data = Object.values(byDistance).map(d => d.avg);

            // Distruggi chart precedente se exists
            if (window.chartInstances.barChartDistanceTraining) {
                window.chartInstances.barChartDistanceTraining.destroy();
            }

            const ctx = canvas.getContext('2d');
            window.chartInstances.barChartDistanceTraining = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Media Punteggio Allenamenti',
                        data: data,
                        backgroundColor: 'rgba(33, 150, 243, 0.7)',
                        borderColor: 'rgb(33, 150, 243)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Punteggio Medio',
                                color: '#fdb927'
                            },
                            ticks: { color: '#fdb927' },
                            grid: { color: 'rgba(74, 74, 74, 0.5)' }
                        },
                        x: {
                            ticks: { color: '#fdb927' },
                            grid: { color: 'rgba(74, 74, 74, 0.5)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fdb927' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dist = context.label;
                                    const count = byDistance[dist].count;
                                    return `Media: ${context.parsed.y.toFixed(1)} punti (${count} sessioni)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawBarChartDistanceRace() {
            const raceSessions = appState.sessionData.filter(s => 
                !s.trainingWithoutScore && s.type === 'Gara'
            );

            const byDistance = {};
            DISTANZA_OPTIONS.forEach(dist => {
                const sessions = raceSessions.filter(s => s.distanza === dist);
                if (sessions.length > 0) {
                    byDistance[dist] = {
                        avg: sessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / sessions.length,
                        count: sessions.length
                    };
                }
            });

            const canvas = document.getElementById('barChartDistanceRace');

            if (Object.keys(byDistance).length === 0) {
                canvas.parentElement.innerHTML = '<div style="height: 300px;"><p class="text-center text-white pt-32">Nessuna gara registrata</p></div>';
                return;
            }

            const labels = Object.keys(byDistance);
            const data = Object.values(byDistance).map(d => d.avg);

            if (window.chartInstances.barChartDistanceRace) {
                window.chartInstances.barChartDistanceRace.destroy();
            }

            const ctx = canvas.getContext('2d');
            window.chartInstances.barChartDistanceRace = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Media Punteggio Gare',
                        data: data,
                        backgroundColor: 'rgba(255, 152, 0, 0.7)',
                        borderColor: 'rgb(255, 152, 0)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Punteggio Medio',
                                color: '#fdb927'
                            },
                            ticks: { color: '#fdb927' },
                            grid: { color: 'rgba(74, 74, 74, 0.5)' }
                        },
                        x: {
                            ticks: { color: '#fdb927' },
                            grid: { color: 'rgba(74, 74, 74, 0.5)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fdb927' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dist = context.label;
                                    const count = byDistance[dist].count;
                                    return `Media: ${context.parsed.y.toFixed(1)} punti (${count} gare)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawBarChartTargetTraining() {
            const turnFilter = document.querySelector('input[name="training-turns-target"]:checked')?.value || 'all';
            
            let trainingSessions = appState.sessionData.filter(s => 
                !s.trainingWithoutScore && s.type === 'Allenamento'
            );

            // Applica filtro turni
            if (turnFilter === '1') {
                trainingSessions = trainingSessions.filter(s => !s.turn2Score || s.turn2Score === 0);
            } else if (turnFilter === '2') {
                trainingSessions = trainingSessions.filter(s => s.turn2Score && s.turn2Score > 0);
            }

            const byTarget = {};
            TIPO_TARGA_OPTIONS.forEach(target => {
                const sessions = trainingSessions.filter(s => s.tipoTarga === target);
                if (sessions.length > 0) {
                    byTarget[target] = {
                        avg: sessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / sessions.length,
                        count: sessions.length
                    };
                }
            });

            const canvas = document.getElementById('barChartTargetTraining');

            if (Object.keys(byTarget).length === 0) {
                canvas.parentElement.innerHTML = '<p class="text-center text-white">Nessun dato disponibile per il filtro selezionato</p>';
                return;
            }

            const labels = Object.keys(byTarget);
            const data = Object.values(byTarget).map(d => d.avg);

            if (window.chartInstances.barChartTargetTraining) {
                window.chartInstances.barChartTargetTraining.destroy();
            }

            const ctx = canvas.getContext('2d');
            window.chartInstances.barChartTargetTraining = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Media Punteggio Allenamenti',
                        data: data,
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: 'rgb(76, 175, 80)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Punteggio Medio',
                                color: '#fdb927'
                            },
                            ticks: { color: '#fdb927' },
                            grid: { color: 'rgba(74, 74, 74, 0.5)' }
                        },
                        x: {
                            ticks: { color: '#fdb927', maxRotation: 45, minRotation: 45 },
                            grid: { color: 'rgba(74, 74, 74, 0.5)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fdb927' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const target = context.label;
                                    const count = byTarget[target].count;
                                    return `Media: ${context.parsed.y.toFixed(1)} punti (${count} sessioni)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawBarChartTargetRace() {
            const raceSessions = appState.sessionData.filter(s => 
                !s.trainingWithoutScore && s.type === 'Gara'
            );

            const byTarget = {};
            TIPO_TARGA_OPTIONS.forEach(target => {
                const sessions = raceSessions.filter(s => s.tipoTarga === target);
                if (sessions.length > 0) {
                    byTarget[target] = {
                        avg: sessions.reduce((sum, s) => sum + (s.totalScore || 0), 0) / sessions.length,
                        count: sessions.length
                    };
                }
            });

            const canvas = document.getElementById('barChartTargetRace');

            if (Object.keys(byTarget).length === 0) {
                canvas.parentElement.innerHTML = '<div style="height: 300px;"><p class="text-center text-white pt-32">Nessuna gara registrata</p></div>';
                return;
            }

            const labels = Object.keys(byTarget);
            const data = Object.values(byTarget).map(d => d.avg);

            if (window.chartInstances.barChartTargetRace) {
                window.chartInstances.barChartTargetRace.destroy();
            }

            const ctx = canvas.getContext('2d');
            window.chartInstances.barChartTargetRace = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Media Punteggio Gare',
                        data: data,
                        backgroundColor: 'rgba(156, 39, 176, 0.7)',
                        borderColor: 'rgb(156, 39, 176)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Punteggio Medio',
                                color: '#fdb927'
                            },
                            ticks: { color: '#fdb927' },
                            grid: { color: 'rgba(74, 74, 74, 0.5)' }
                        },
                        x: {
                            ticks: { color: '#fdb927', maxRotation: 45, minRotation: 45 },
                            grid: { color: 'rgba(74, 74, 74, 0.5)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fdb927' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const target = context.label;
                                    const count = byTarget[target].count;
                                    return `Media: ${context.parsed.y.toFixed(1)} punti (${count} gare)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawHeatmapDays() {
            const validSessions = appState.sessionData.filter(s => !s.trainingWithoutScore);

            const dayNames = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const dayData = Array(7).fill(null).map(() => ({ count: 0, totalScore: 0 }));

            validSessions.forEach(session => {
                const date = new Date(session.data);
                const dayIndex = date.getDay();
                dayData[dayIndex].count++;
                dayData[dayIndex].totalScore += session.totalScore || 0;
            });

            const html = `
                <div class="grid grid-cols-7 gap-2">
                    ${dayData.map((data, index) => {
                        const avgScore = data.count > 0 ? data.totalScore / data.count : 0;
                        const maxAvg = Math.max(...dayData.map(d => d.count > 0 ? d.totalScore / d.count : 0));
                        const intensity = maxAvg > 0 ? (avgScore / maxAvg) : 0;
                        
                        const bgColor = intensity > 0.8 ? 'bg-green-600' :
                                       intensity > 0.6 ? 'bg-green-500' :
                                       intensity > 0.4 ? 'bg-yellow-500' :
                                       intensity > 0.2 ? 'bg-orange-500' :
                                       intensity > 0 ? 'bg-red-500' : 'bg-gray-700';
                        
                        return `
                            <div class="${bgColor} p-3 rounded-lg text-center ${data.count > 0 ? 'cursor-pointer hover:opacity-80' : ''}"
                                 title="${dayNames[index]}: ${data.count} sessioni, media ${avgScore.toFixed(1)}">
                                <div class="text-xs font-bold text-white mb-1">${dayNames[index].substring(0, 3)}</div>
                                <div class="text-lg font-bold text-white">${data.count > 0 ? avgScore.toFixed(0) : '-'}</div>
                                <div class="text-xs text-white opacity-75">${data.count} sess.</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="mt-3 text-xs text-center text-gray-400">
                    üü¢ Migliori prestazioni | üî¥ Prestazioni inferiori
                </div>
            `;

            document.getElementById('heatmapDays').innerHTML = html;
        }

        function drawHeatmapHours() {
            const validSessions = appState.sessionData.filter(s => !s.trainingWithoutScore && s.startTime);

            const hourData = Array(24).fill(null).map(() => ({ count: 0, totalScore: 0 }));

            validSessions.forEach(session => {
                const hour = parseInt(session.startTime.split(':')[0]);
                hourData[hour].count++;
                hourData[hour].totalScore += session.totalScore || 0;
            });

            const maxAvg = Math.max(...hourData.map(d => d.count > 0 ? d.totalScore / d.count : 0));

            const html = `
                <div class="grid grid-cols-8 sm:grid-cols-12 gap-2">
                    ${hourData.map((data, hour) => {
                        const avgScore = data.count > 0 ? data.totalScore / data.count : 0;
                        const intensity = maxAvg > 0 ? (avgScore / maxAvg) : 0;
                        
                        const bgColor = intensity > 0.8 ? 'bg-green-600' :
                                       intensity > 0.6 ? 'bg-green-500' :
                                       intensity > 0.4 ? 'bg-yellow-500' :
                                       intensity > 0.2 ? 'bg-orange-500' :
                                       intensity > 0 ? 'bg-red-500' : 'bg-gray-700';
                        
                        return `
                            <div class="${bgColor} p-2 rounded-lg text-center ${data.count > 0 ? 'cursor-pointer hover:opacity-80' : ''}"
                                 title="Ore ${hour}:00 - ${data.count} sessioni, media ${avgScore.toFixed(1)}">
                                <div class="text-xs font-bold text-white">${hour}h</div>
                                <div class="text-sm font-bold text-white">${data.count > 0 ? avgScore.toFixed(0) : '-'}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="mt-3 text-xs text-center text-gray-400">
                    üü¢ Migliori prestazioni | üî¥ Prestazioni inferiori
                </div>
            `;

            document.getElementById('heatmapHours').innerHTML = html;
        }

        function drawConsistencyChart() {
            const validSessions = appState.sessionData.filter(s => !s.trainingWithoutScore);

            if (validSessions.length < 5) {
                document.getElementById('consistencyChart').parentElement.innerHTML = '<p class="text-center text-white">Servono almeno 5 sessioni per il grafico consistenza</p>';
                return;
            }

            // Calcola deviazione standard per finestre mobili di 5 sessioni
            const windowSize = 5;
            const labels = [];
            const stdDevs = [];

            for (let i = windowSize - 1; i < validSessions.length; i++) {
                const window = validSessions.slice(i - windowSize + 1, i + 1);
                const scores = window.map(s => s.totalScore || 0);
                const avg = scores.reduce((a, b) => a + b, 0) / windowSize;
                const variance = scores.reduce((sum, score) => sum + Math.pow(score - avg, 2), 0) / windowSize;
                const stdDev = Math.sqrt(variance);

                labels.push(`#${i + 1}`);
                stdDevs.push(stdDev);
            }

            const ctx = document.getElementById('consistencyChart').getContext('2d');

            if (window.chartInstances.consistencyChart) {
                window.chartInstances.consistencyChart.destroy();
            }

            window.chartInstances.consistencyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Deviazione Standard (ultime 5 sessioni)',
                        data: stdDevs,
                        backgroundColor: 'rgba(33, 150, 243, 0.3)',
                        borderColor: 'rgb(33,150, 243)',
borderWidth: 2,
fill: true,
tension: 0.4
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: {
beginAtZero: true,
title: {
display: true,
text: 'Deviazione Standard (minore = pi√π costante)',
color: '#fdb927'
},
ticks: { color: '#fdb927' },
grid: { color: 'rgba(74, 74, 74, 0.5)' }
},
x: {
title: {
display: true,
text: 'Progressione Sessioni',
color: '#fdb927'
},
ticks: { color: '#fdb927', maxRotation: 0 },
grid: { color: 'rgba(74, 74, 74, 0.5)' }
}
},
plugins: {
legend: {
labels: { color: '#fdb927' }
},
tooltip: {
callbacks: {
label: function(context) {
const value = context.parsed.y;
const quality = value < 10 ? 'üü¢ Ottima' : value < 20 ? 'üü° Buona' : 'üî¥ Variabile';
return Consistenza: ${value.toFixed(2)} ${quality};
}
}
}
}
}
});
}
// FINE PARTE4H
// PARTE4I - Export, Backup e Condivisione Dati
        function renderExportData() {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            fetchSessions();

            setTimeout(() => {
                const html = `
                    <h2 class="text-3xl font-bold mb-6 text-white">üì• Esporta & Backup</h2>

                    <!-- Esportazione CSV -->
                    <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üìä Esporta in CSV</h3>
                        <p class="text-sm text-white mb-4">Esporta tutte le tue sessioni in formato CSV per analisi con Excel o altri strumenti.</p>
                        <button class="btn-primary w-full p-3 rounded-lg" onclick="window.exportToCSV()">
                            üìÑ Scarica CSV
                        </button>
                    </div>

                    <!-- Esportazione JSON (Backup Completo) -->
                    <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üíæ Backup Completo (JSON)</h3>
                        <p class="text-sm text-white mb-4">Scarica un backup completo di tutti i tuoi dati in formato JSON. Include sessioni, obiettivi e statistiche.</p>
                        <button class="btn-primary w-full p-3 rounded-lg" onclick="window.exportFullBackup()">
                            üíæ Scarica Backup Completo
                        </button>
                    </div>

                    <!-- Stampa Report -->
                    <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üñ®Ô∏è Stampa Report</h3>
                        <p class="text-sm text-white mb-4">Genera un report stampabile delle tue sessioni.</p>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-white">Periodo Report</label>
                                <select id="report-period" class="input-style">
                                    <option value="all">Tutte le sessioni</option>
                                    <option value="month">Ultimo mese</option>
                                    <option value="3months">Ultimi 3 mesi</option>
                                    <option value="6months">Ultimi 6 mesi</option>
                                    <option value="year">Ultimo anno</option>
                                </select>
                            </div>
                            <button class="btn-primary w-full p-3 rounded-lg" onclick="window.generatePrintReport()">
                                üñ®Ô∏è Genera e Stampa Report
                            </button>
                        </div>
                    </div>

                    <!-- Condividi Singola Sessione -->
                    <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-xl font-bold mb-4 text-primary-orange">üì§ Condividi Sessione</h3>
                        <p class="text-sm text-white mb-4">Crea un'immagine condivisibile di una sessione specifica.</p>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1 text-white">Seleziona Sessione</label>
                                <select id="share-session-select" class="input-style">
                                    <option value="">Scegli una sessione...</option>
                                    ${appState.sessionData.slice(-20).reverse().map(session => `
                                        <option value="${session.id}">
                                            ${formatDate(session.data)} - ${session.type} (${session.totalScore} pts)
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <button class="btn-primary w-full p-3 rounded-lg" onclick="window.shareSession()">
                                üì∏ Crea Immagine Condivisibile
                            </button>
                        </div>
                    </div>

                    <!-- Importa Backup -->
                    <div class="bg-secondary-dark p-6 rounded-xl shadow-lg mb-6 border-2 border-yellow-500">
                        <h3 class="text-xl font-bold mb-4 text-yellow-400">üì• Importa Backup</h3>
                        <p class="text-sm text-white mb-4">‚ö†Ô∏è Attenzione: Questa funzione √® in sviluppo. L'importazione potrebbe sovrascrivere dati esistenti.</p>
                        <input type="file" id="import-file" accept=".json" class="input-style mb-3" disabled>
                        <button class="btn-primary w-full p-3 rounded-lg opacity-50 cursor-not-allowed" disabled>
                            üì• Importa Backup (Presto Disponibile)
                        </button>
                    </div>

                    <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                        Torna al Menu
                    </button>
                `;

                document.getElementById('content-view').innerHTML = html;
            }, 300);
        }

        window.exportToCSV = () => {
            const sessions = appState.sessionData;

            if (sessions.length === 0) {
                showModal("Nessun Dato", "Non ci sono sessioni da esportare.", [
                    { text: "Ok", handler: () => {} }
                ]);
                return;
            }

            // Intestazioni CSV
            const headers = [
                'Data', 'Tipo', 'Luogo', 'Tipo Luogo', 'Distanza', 'Tipo Targa', 'Formato',
                'Punteggio Totale', 'Turno 1', 'Turno 2', 'X Totali', '10 Totali', '9 Totali',
                'Media Freccia', 'Durata (min)', 'Ora Inizio', 'Ora Fine', 'Note',
                'Allenamento Tecnico', 'Quick Score'
            ];

            // Dati
            const rows = sessions.map(s => [
                formatDate(s.data),
                s.type || '',
                s.luogo || '',
                s.tipoLuogo || '',
                s.distanza || '',
                s.tipoTarga || '',
                s.formatoGara || '',
                s.totalScore || 0,
                s.turn1Score || 0,
                s.turn2Score || 0,
                s.totalX || 0,
                s.totalTen || 0,
                s.totalNine || 0,
                s.totalAverage ? s.totalAverage.toFixed(2) : 0,
                s.duration || 0,
                s.startTime || '',
                s.endTime || '',
                (s.note || '').replace(/"/g, '""'),
                s.trainingWithoutScore ? 'S√¨' : 'No',
                s.quickScore ? 'S√¨' : 'No'
            ]);

            // Costruisci CSV
            let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `archery_sessions_${appState.loggedInArcher.nome}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showModal("Successo", "File CSV scaricato con successo!", [
                { text: "Ok", handler: () => {} }
            ]);
        };

        window.exportFullBackup = async () => {
            try {
                // Raccogli tutti i dati
                const sessionsData = appState.sessionData;
                
                // Carica obiettivi
                await loadGoals();
                const goalsData = appState.userGoals;

                const backupData = {
                    exportDate: new Date().toISOString(),
                    archerName: appState.loggedInArcher.nome,
                    version: '1.0',
                    sessions: sessionsData,
                    goals: goalsData,
                    totalSessions: sessionsData.length,
                    totalGoals: goalsData.length
                };

                // Converti in JSON
                const jsonContent = JSON.stringify(backupData, null, 2);

                // Download
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `archery_backup_${appState.loggedInArcher.nome}_${new Date().toISOString().split('T')[0]}.json`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showModal("Backup Completato", `Backup completo scaricato con successo!<br><br>üìä ${sessionsData.length} sessioni<br>üéØ ${goalsData.length} obiettivi`, [
                    { text: "Ok", handler: () => {} }
                ]);

            } catch (error) {
                console.error("Errore backup:", error);
                showModal("Errore", "Impossibile creare il backup.", [
                    { text: "Ok", handler: () => {} }
                ]);
            }
        };

        window.generatePrintReport = () => {
            const period = document.getElementById('report-period').value;
            let filteredSessions = [...appState.sessionData];

            // Filtra per periodo
            if (period !== 'all') {
                const now = new Date();
                const cutoffDate = new Date();

                switch (period) {
                    case 'month':
                        cutoffDate.setMonth(now.getMonth() - 1);
                        break;
                    case '3months':
                        cutoffDate.setMonth(now.getMonth() - 3);
                        break;
                    case '6months':
                        cutoffDate.setMonth(now.getMonth() - 6);
                        break;
                    case 'year':
                        cutoffDate.setFullYear(now.getFullYear() - 1);
                        break;
                }

                filteredSessions = filteredSessions.filter(s => {
                    const sessionDate = new Date(s.data);
                    return sessionDate >= cutoffDate;
                });
            }

            if (filteredSessions.length === 0) {
                showModal("Nessun Dato", "Nessuna sessione trovata per il periodo selezionato.", [
                    { text: "Ok", handler: () => {} }
                ]);
                return;
            }

            // Calcola statistiche
            const validSessions = filteredSessions.filter(s => !s.trainingWithoutScore);
            const totalScore = validSessions.reduce((sum, s) => sum + (s.totalScore || 0), 0);
            const avgScore = validSessions.length > 0 ? totalScore / validSessions.length : 0;
            const maxScore = validSessions.length > 0 ? Math.max(...validSessions.map(s => s.totalScore || 0)) : 0;

            // Crea finestra di stampa
            const printWindow = window.open('', '', 'width=800,height=600');
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Report Archery - ${appState.loggedInArcher.nome}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            color: #000;
                        }
                        h1, h2 { color: #fdb927; }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background-color: #fdb927;
                            color: white;
                        }
                        .stats-box {
                            background: #f5f5f5;
                            border: 2px solid #fdb927;
                            padding: 15px;
                            margin: 20px 0;
                            border-radius: 8px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                        }
                        .stat-item {
                            text-align: center;
                        }
                        .stat-value {
                            font-size: 24px;
                            font-weight: bold;
                            color: #fdb927;
                        }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üèπ Report Archery - ${appState.loggedInArcher.nome}</h1>
                    <p><strong>Data Report:</strong> ${formatDate(new Date().toISOString().split('T')[0])}</p>
                    <p><strong>Periodo:</strong> ${period === 'all' ? 'Tutte le sessioni' : 
                        period === 'month' ? 'Ultimo mese' :
                        period === '3months' ? 'Ultimi 3 mesi' :
                        period === '6months' ? 'Ultimi 6 mesi' : 'Ultimo anno'}</p>

                    <div class="stats-box">
                        <h2>üìä Statistiche Riepilogo</h2>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">${filteredSessions.length}</div>
                                <div>Sessioni Totali</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${avgScore.toFixed(1)}</div>
                                <div>Media Punteggio</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${maxScore}</div>
                                <div>Record Personale</div>
                            </div>
                        </div>
                    </div>

                    <h2>üìã Dettaglio Sessioni</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Distanza</th>
                                <th>Targa</th>
                                <th>Punteggio</th>
                                <th>T1</th>
                                <th>T2</th>
                                <th>Luogo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredSessions.map(s => `
                                <tr>
                                    <td>${formatDate(s.data)}</td>
                                    <td>${s.type}${s.trainingWithoutScore ? ' üéì' : s.quickScore ? ' ‚ö°' : ''}</td>
                                    <td>${s.distanza || '-'}</td>
                                    <td>${s.tipoTarga || '-'}</td>
                                    <td><strong>${s.trainingWithoutScore ? '-' : s.totalScore || 0}</strong></td>
                                    <td>${s.trainingWithoutScore ? '-' : s.turn1Score || 0}</td>
                                    <td>${s.trainingWithoutScore ? '-' : s.turn2Score || 0}</td>
                                    <td>${s.luogo}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #fdb927; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            üñ®Ô∏è Stampa Report
                        </button>
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(printContent);
            printWindow.document.close();
        };

        window.shareSession = () => {
            const sessionId = document.getElementById('share-session-select').value;

            if (!sessionId) {
                showModal("Errore", "Seleziona una sessione da condividere.", [
                    { text: "Ok", handler: () => {} }
                ]);
                return;
            }

            const session = appState.sessionData.find(s => String(s.id) === String(sessionId));

            if (!session) {
                showModal("Errore", "Sessione non trovata.", [
                    { text: "Ok", handler: () => {} }
                ]);
                return;
            }

            // Crea canvas per l'immagine
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');

            // Sfondo
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Titolo
            ctx.fillStyle = '#fdb927';
            ctx.font = 'bold 40px Inter, Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üèπ Archery Tracker', canvas.width / 2, 60);

            // Nome arciere
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 28px Inter, Arial';
            ctx.fillText(appState.loggedInArcher.nome, canvas.width / 2, 110);

            // Tipo e data
            ctx.font = '24px Inter, Arial';
            ctx.fillStyle = '#fdb927';
            ctx.fillText(`${session.type} - ${formatDate(session.data)}`, canvas.width / 2, 160);

            // Punteggio principale
            if (!session.trainingWithoutScore) {
                ctx.font = 'bold 80px Inter, Arial';
                ctx.fillStyle = '#ffffff';
                ctx.fillText(session.totalScore, canvas.width / 2, 260);

                ctx.font = '20px Inter, Arial';
                ctx.fillStyle = '#fdb927';
                ctx.fillText('Punteggio Totale', canvas.width / 2, 290);
            } else {
                ctx.font = 'bold 32px Inter, Arial';
                ctx.fillStyle = '#ffffff';
                ctx.fillText('Allenamento Tecnico', canvas.width / 2, 240);
            }

            // Dettagli
            ctx.textAlign = 'left';
            ctx.font = '20px Inter, Arial';
            ctx.fillStyle = '#ffffff';
            
            let yPos = 350;
            const leftX = 100;
            const rightX = 450;

            if (!session.trainingWithoutScore) {
                ctx.fillText(`üìè ${session.distanza}`, leftX, yPos);
                ctx.fillText(`üéØ ${session.tipoTarga}`, rightX, yPos);
                yPos += 40;

                if (!session.quickScore) {
                    ctx.fillText(`X: ${session.totalX || 0}`, leftX, yPos);
                    ctx.fillText(`10: ${session.totalTen || 0}`, rightX, yPos);
                    yPos += 40;

                    ctx.fillText(`Media: ${session.totalAverage ? session.totalAverage.toFixed(2) : 0}`, leftX, yPos);
                }
            }

            ctx.fillText(`üìç ${session.luogo}`, leftX, yPos + 40);
            ctx.fillText(`${session.tipoLuogo}`, rightX, yPos + 40);

            // Footer
            ctx.textAlign = 'center';
            ctx.font = '16px Inter, Arial';
            ctx.fillStyle = '#666666';
            ctx.fillText('Generato da Archery Tracker', canvas.width / 2, canvas.height - 30);

            // Converti in immagine e scarica
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `archery_session_${formatDate(session.data)}.png`;
                link.click();
                URL.revokeObjectURL(url);

                showModal("Successo", "Immagine creata e scaricata! Ora puoi condividerla sui social o via messaggio.", [
                    { text: "Ok", handler: () => {} }
                ]);
            });
        };
        // FINE PARTE4I
// PARTE4J - Calendario Sessioni
        function renderCalendar() {
            if (!appState.loggedInArcher) {
                window.setView('login');
                return;
            }

            fetchSessions();

            setTimeout(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const html = `
                    <h2 class="text-3xl font-bold mb-6 text-white">üìÖ Calendario Sessioni</h2>

                    <!-- Controlli Calendario -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <div class="flex justify-between items-center">
                            <button class="btn-primary p-2 rounded-lg" onclick="window.changeCalendarMonth(-1)">
                                ‚óÄ Precedente
                            </button>
                            <div class="text-center">
                                <h3 class="text-2xl font-bold text-white" id="calendar-month-year"></h3>
                            </div>
                            <button class="btn-primary p-2 rounded-lg" onclick="window.changeCalendarMonth(1)">
                                Successivo ‚ñ∂
                            </button>
                        </div>
                    </div>

                    <!-- Legenda -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6">
                        <h4 class="text-sm font-bold mb-2 text-white">Legenda:</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-orange-500 rounded mr-2"></div>
                                <span class="text-white">Gara</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
                                <span class="text-white">Allenamento</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-purple-500 rounded mr-2"></div>
                                <span class="text-white">Allenamento Tecnico</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                                <span class="text-white">Oggi</span>
                            </div>
                        </div>
                    </div>

                    <!-- Calendario -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6" id="calendar-grid">
                        <!-- Il calendario verr√† inserito qui -->
                    </div>

                    <!-- Riepilogo Sessioni del Mese -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6" id="month-summary">
                        <!-- Il riepilogo verr√† inserito qui -->
                    </div>

                    <!-- Statistiche Mensili -->
                    <div class="bg-secondary-dark p-4 rounded-xl shadow-lg mb-6" id="month-stats">
                        <!-- Le statistiche verranno inserite qui -->
                    </div>

                    <button class="btn-primary w-full p-3 rounded-lg bg-secondary-dark text-primary-orange border border-primary-orange" onclick="window.setView('mainMenu')">
                        Torna al Menu
                    </button>
                `;

                document.getElementById('content-view').innerHTML = html;

                // Inizializza stato calendario
                window.calendarState = {
                    currentMonth: currentMonth,
                    currentYear: currentYear
                };

                renderCalendarGrid();
            }, 300);
        }

        window.changeCalendarMonth = (delta) => {
            window.calendarState.currentMonth += delta;

            if (window.calendarState.currentMonth > 11) {
                window.calendarState.currentMonth = 0;
                window.calendarState.currentYear++;
            } else if (window.calendarState.currentMonth < 0) {
                window.calendarState.currentMonth = 11;
                window.calendarState.currentYear--;
            }

            renderCalendarGrid();
        };

        function renderCalendarGrid() {
            const { currentMonth, currentYear } = window.calendarState;

            // Nome mese
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            document.getElementById('calendar-month-year').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Calcola giorni del mese
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay(); // 0 = Domenica

            // Filtra sessioni del mese
            const monthSessions = appState.sessionData.filter(session => {
                const sessionDate = new Date(session.data);
                return sessionDate.getMonth() === currentMonth && 
                       sessionDate.getFullYear() === currentYear;
            });

            // Crea mappa sessioni per giorno
            const sessionsByDay = {};
            monthSessions.forEach(session => {
                const day = new Date(session.data).getDate();
                if (!sessionsByDay[day]) {
                    sessionsByDay[day] = [];
                }
                sessionsByDay[day].push(session);
            });

            // Costruisci griglia calendario
            let calendarHTML = `
                <div class="grid grid-cols-7 gap-1 mb-2">
                    ${['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'].map(day => 
                        `<div class="text-center font-bold text-primary-orange text-sm p-2">${day}</div>`
                    ).join('')}
                </div>
                <div class="grid grid-cols-7 gap-1">
            `;

            // Celle vuote prima del primo giorno
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarHTML += `<div class="bg-gray-800 rounded p-2 h-20"></div>`;
            }

            // Giorni del mese
            const today = new Date();
            const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;

            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = isCurrentMonth && today.getDate() === day;
                const sessions = sessionsByDay[day] || [];
                
                let cellClass = 'bg-gray-800 rounded p-2 h-20 relative';
                if (isToday) {
                    cellClass += ' border-2 border-green-500';
                }

                let sessionIndicators = '';
                if (sessions.length > 0) {
                    // Mostra fino a 3 indicatori
                    sessionIndicators = sessions.slice(0, 3).map(s => {
                        let color = 'bg-blue-500'; // Default allenamento
                        if (s.type === 'Gara') color = 'bg-orange-500';
                        if (s.trainingWithoutScore) color = 'bg-purple-500';
                        
                        return `<div class="${color} h-1 w-full rounded mb-1" title="${s.type} - ${s.totalScore || 'N/A'} pts"></div>`;
                    }).join('');

                    if (sessions.length > 3) {
                        sessionIndicators += `<div class="text-xs text-primary-orange text-center">+${sessions.length - 3}</div>`;
                    }
                }

                calendarHTML += `
                    <div class="${cellClass} cursor-pointer hover:bg-gray-700 transition-all" 
                         onclick="window.showDayDetails(${day})"
                         title="${sessions.length > 0 ? `${sessions.length} sessione/i` : 'Nessuna sessione'}">
                        <div class="text-white font-bold text-sm mb-1">${day}</div>
                        ${sessionIndicators}
                    </div>
                `;
            }

            calendarHTML += `</div>`;

            document.getElementById('calendar-grid').innerHTML = calendarHTML;

            // Riepilogo sessioni
            renderMonthSummary(monthSessions);

            // Statistiche mensili
            renderMonthStats(monthSessions);
        }

        window.showDayDetails = (day) => {
            const { currentMonth, currentYear } = window.calendarState;
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            const daySessions = appState.sessionData.filter(s => s.data === dateStr);

            if (daySessions.length === 0) {
                showModal(
                    `üìÖ ${day} ${['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'][currentMonth]}`,
                    "Nessuna sessione registrata in questo giorno.",
                    [{ text: "Ok", handler: () => {} }]
                );
                return;
            }

            const modalContent = document.createElement('div');
            modalContent.innerHTML = `
                <div class="space-y-3">
                    ${daySessions.map(session => `
                        <div class="bg-gray-800 p-3 rounded-lg cursor-pointer hover:bg-gray-700"
                             onclick="window.setView('detailedSummary', { sessionId: '${session.id}' }); window.closeModal();">
                            <div class="font-bold text-white">${session.type}${session.trainingWithoutScore ? ' üéì' : session.quickScore ? ' ‚ö°' : ''}</div>
                            <div class="text-sm text-primary-orange">
                                ${session.trainingWithoutScore ? 'Allenamento Tecnico' : `${session.totalScore} punti`} | 
                                ${session.distanza || '-'} | ${session.tipoTarga || '-'}
                            </div>
                            <div class="text-xs text-gray-400 mt-1">${session.luogo} (${session.tipoLuogo})</div>
                        </div>
                    `).join('')}
                </div>
            `;

            showModal(
                `üìÖ ${day} ${['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                          'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'][currentMonth]} - ${daySessions.length} Sessione/i`,
                modalContent,
                [{ text: "Chiudi", handler: () => {} }]
            );
        };

        window.closeModal = closeModal;

        function renderMonthSummary(sessions) {
            if (sessions.length === 0) {
                document.getElementById('month-summary').innerHTML = `
                    <h4 class="text-lg font-bold mb-3 text-white">üìã Sessioni del Mese</h4>
                    <p class="text-center text-gray-400">Nessuna sessione registrata in questo mese.</p>
                `;
                return;
            }

            const sortedSessions = [...sessions].sort((a, b) => new Date(a.data) - new Date(b.data));

            const html = `
                <h4 class="text-lg font-bold mb-3 text-white">üìã Sessioni del Mese (${sessions.length})</h4>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    ${sortedSessions.map(session => {
                        let bgColor = 'bg-gray-800';
                        if (session.type === 'Gara') bgColor = 'bg-orange-900 bg-opacity-30';
                        if (session.trainingWithoutScore) bgColor = 'bg-purple-900 bg-opacity-30';

                        return `
                            <div class="${bgColor} p-3 rounded-lg cursor-pointer hover:opacity-80"
                                 onclick="window.setView('detailedSummary', { sessionId: '${session.id}' })">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-bold text-white">${formatDate(session.data)}</span>
                                        <span class="text-sm text-primary-orange ml-2">${session.type}${session.trainingWithoutScore ? ' üéì' : session.quickScore ? ' ‚ö°' : ''}</span>
                                    </div>
                                    <div class="font-bold text-white text-lg">
                                        ${session.trainingWithoutScore ? '-' : session.totalScore}
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    ${session.distanza || '-'} | ${session.tipoTarga || '-'} | ${session.luogo}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.getElementById('month-summary').innerHTML = html;
        }

        function renderMonthStats(sessions) {
            const validSessions = sessions.filter(s => !s.trainingWithoutScore);

            if (validSessions.length === 0) {
                document.getElementById('month-stats').innerHTML = `
                    <h4 class="text-lg font-bold mb-3 text-white">üìä Statistiche Mensili</h4>
                    <p class="text-center text-gray-400">Nessuna sessione con punteggio in questo mese.</p>
                `;
                return;
            }

            const totalScore = validSessions.reduce((sum, s) => sum + (s.totalScore || 0), 0);
            const avgScore = totalScore / validSessions.length;
            const maxScore = Math.max(...validSessions.map(s => s.totalScore || 0));
            const bestSession = validSessions.find(s => s.totalScore === maxScore);

            const allenamenti = sessions.filter(s => s.type === 'Allenamento').length;
            const gare = sessions.filter(s => s.type === 'Gara').length;
            const tecnici = sessions.filter(s => s.trainingWithoutScore).length;

            const html = `
                <h4 class="text-lg font-bold mb-3 text-white">üìä Statistiche Mensili</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-gray-800 p-3 rounded-lg text-center">
                        <div class="text-xs text-primary-orange mb-1">Sessioni Totali</div>
                        <div class="text-2xl font-bold text-white">${sessions.length}</div>
                    </div>
                    <div class="bg-gray-800 p-3 rounded-lg text-center">
                        <div class="text-xs text-primary-orange mb-1">Media Punteggio</div>
                        <div class="text-2xl font-bold text-white">${avgScore.toFixed(1)}</div>
                    </div>
                    <div class="bg-gray-800 p-3 rounded-lg text-center">
                        <div class="text-xs text-primary-orange mb-1">Miglior Punteggio</div>
                        <div class="text-2xl font-bold text-green-400">${maxScore}</div>
                    </div>
                    <div class="bg-gray-800 p-3 rounded-lg text-center">
                        <div class="text-xs text-primary-orange mb-1">A / G / T</div>
                        <div class="text-xl font-bold text-white">${allenamenti} / ${gare} / ${tecnici}</div>
                    </div>
                </div>
                ${bestSession ? `
                    <div class="mt-4 bg-green-900 bg-opacity-30 p-3 rounded-lg border border-green-500">
                        <p class="text-sm text-green-400 text-center">
                            üèÜ Miglior prestazione: ${maxScore} punti il ${formatDate(bestSession.data)}
                        </p>
                    </div>
                ` : ''}
            `;

            document.getElementById('month-stats').innerHTML = html;
        }
        // FINE PARTE4J
        // Inizializza l'applicazione al caricamento dell'autenticazione
        window.setView('login');
    };
</script>
</body>
</html>
